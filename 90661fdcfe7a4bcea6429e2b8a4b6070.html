<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="操作系统实验——线程创建与调度">
    <meta property="og:type" content="blog">
  <title>操作系统实验——线程创建与调度</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="🏡">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism-solarizedlight.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='https://unpkg.com/valine/dist/Valine.min.js'></script>
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>🏡</span> <span>Home</span></div>
    </a>
                                                                                                                                                                                                                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="links.html">
      <div class="Navbar__Btn"><span>🔗</span> <span>Links</span></div>
    </a>
                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>👦🏻</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
        <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    <div>
            <span class="Header__Title">操作系统实验——线程创建与调度</span>

    </div>
        <div class="DateTagBar">
            <span class="DateTagBar__Item DateTagBar__Date">Posted on Thu, Apr 18, 2019</span>
                  <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
        <a href="tag/操作系统.html">操作系统</a>
      </span>
          </div>
      </header>
  <article id="https://www.notion.so/90661fdcfe7a4bcea6429e2b8a4b6070" class="PageRoot"><ul id="https://www.notion.so/5dd41b82b4ca4e208355625b18049ad7" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/43195c09d3b347a0ae6b99a6e4914a68"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验目的</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1addc10c34bb464b8da9d28d297a7804"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验内容</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/da401857fe8b4a07b9921f60dd7eda6e"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">预备知识</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/85e7f1442f94491b8bc1fa9aa7992ab6"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">线程API</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/67a65a83cea143448c61be2e59a834b5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">随机数组生成</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0a7d1cdd2cce40399d2cd26b27b12e1c"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">图形模式API</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9253b17297f34d98a1c5b65ef60b894d"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">线程调度</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8869fd2084484f8d953d6dde3d8ef24f"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">关于定点数</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1bebb44626ab4b5f89b486670598bfe8"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验步骤</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4c27bc80f41e4f43831374dc2525aa8e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">增加tcb属性nice</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3b2a294b609547229e00c7b59bd9da3b"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">增加系统调用</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d18ccfd0b38243d7ab036e81e558ece9"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">tcb增加动态优先级属性</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/99e9f334d2df4db788c0a08a1b2c2124"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">优先级调度算法</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c4974f72bfa14a6bad19e8bcfa14526d"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">测试调度器</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8fca5423c47742c7894159071fa0fd10"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验结果</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0cbe148298ea4c769fde7eaf5d3382fa"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></div></a></li></ul><div id="https://www.notion.so/a589eac317864619b1eac9e2dabb02e7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a85289dd5d174239934412ac05a9e845" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">说明：</span></span></p></div><blockquote id="https://www.notion.so/cc2af22d5d1047ebb43456e898b1612f" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">最近做了实验二和实验三，由于两者相关，所以堆在一起总结。
另外注意到，各个bbs上也流传着往届学长写的总结，这也是老师只甩给我们PPT，我们也能做出这实验的原因之一。
在此呢，我就写写自己的总结，当然也参考了往届学长的做法（，并且还把老师的PPT抄了一遍）。</span></span></blockquote><h2 id="https://www.notion.so/43195c09d3b347a0ae6b99a6e4914a68" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/43195c09d3b347a0ae6b99a6e4914a68"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验目的</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/764cccda03dd4357997c7ac8cda962d1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">掌握线程的创建</span></span></li><li id="https://www.notion.so/1a6f9c2bdb4a4deab650fd9b914797fc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">掌握线程的调度</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/7913817a94bd4a16bcc4fb50b650396f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">静态优先级调度</span></span></li><li id="https://www.notion.so/64adfa5766854a5f81ac6b2999250219" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">动态优先级调度</span></span></li></ul></li></ul><h2 id="https://www.notion.so/1addc10c34bb464b8da9d28d297a7804" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1addc10c34bb464b8da9d28d297a7804"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验内容</span></span></h2><div id="https://www.notion.so/b664e004af6c4173a9d0019459fc7c3c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">先贴实验内容：（EPOS系统，我会在上篇文章的实验一给出）</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/574dd4590c2b4df2b22d5c7b3d5bfba5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">创建两个冒泡排序的线程，记为A和B</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/4dbac2c303ed42c98a88499b626b8d53" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">分别占用屏幕的两个位置</span></span></li><li id="https://www.notion.so/062246afb2c741abae54976600f0407d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在屏幕上用进度条动态显示两个线程的静态优先级</span></span></li></ul></li><li id="https://www.notion.so/c826e396c02045d5ae65c9b185257c85" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">另外创建一个控制线程</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/f01392d3de27430c8e51d391952c5bf4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">循环等待键盘输入</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/0f2eef5e09b4481cad7a91b387239f0f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int key = getchar();</code></span></span></li></ul></li><li id="https://www.notion.so/e78a0396d93b409798cfbec1741edd9b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果key==0x4800(up)/0x5000(down)</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/60f82b79b3bc4258a08ddf97474b915a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">setpriority</code></span><span class="SemanticString">调高/低A线程的静态优先级</span></span></li><li id="https://www.notion.so/76522a2116794d868708dca1db2b3230" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">更新A的优先级进度条</span></span></li></ul></li><li id="https://www.notion.so/a9036ce0fa134c16b2c51794a9c386f2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果key==0x4d00(right)/0x4b00(left)</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/6ba5bff674d74aeaa52a3867eceee068" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">setpriority</code></span><span class="SemanticString">调高/低B线程的静态优先级</span></span></li><li id="https://www.notion.so/339e5418663e405693433dc867fee0a8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">更新B的优先级进度条</span></span></li></ul></li><li id="https://www.notion.so/2fdda43316974e1fa7bd2f32b77cbcae" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">把控制线程的静态优先级设置到最高，以保证控制效果</span></span></li></ul></li></ul><h2 id="https://www.notion.so/da401857fe8b4a07b9921f60dd7eda6e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/da401857fe8b4a07b9921f60dd7eda6e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">预备知识</span></span></h2><h3 id="https://www.notion.so/85e7f1442f94491b8bc1fa9aa7992ab6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/85e7f1442f94491b8bc1fa9aa7992ab6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">线程API</span></span></h3><div id="https://www.notion.so/f2787da083e64023be35915b1201e8b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面说明实验所用到的API函数。
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">线程创建</strong></span></span></p></div><pre id="https://www.notion.so/894f215f632d474d803b2ae3bc3d0994" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">task_create</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>tos<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/4f3af4feacbb43a4847e7c9c9516c89e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">tos</code></span><span class="SemanticString"> ：用户栈的栈顶指针
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">func</code></span><span class="SemanticString"> ：线程函数
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pv</code></span><span class="SemanticString"> ：传递给线程函数func的参数，一般传结构体指针以传多个参数
返回值 ：大于0，则表示新创建线程之ID</span></span></p></div><div id="https://www.notion.so/5c0203853a854a6882b4e15cae20f9e1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">线程退出</strong></span></span></p></div><pre id="https://www.notion.so/1c3de7c1716d4d13974779fd14c66718" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> code_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/dae496be0e9c4e7c9d123354ef60bbfa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">code_exit</code></span><span class="SemanticString"> ：线程的退出代码</span></span></p></div><div id="https://www.notion.so/e2dd2777738b45ff93cce870b848a59a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">获取当前线程的ID</strong></span></span></p></div><pre id="https://www.notion.so/6a8c1ac4be204182a0bcfac7b8750460" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">task_getid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/4ac9fe611a5142a1bafbab9ae4b3564a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">等待线程退出</strong></span></span></p></div><pre id="https://www.notion.so/709cfb77842c4431b2fd4a65ea7ea870" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">task_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>pcode_exit<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/e885de2a0ba24414bb48be4d48c11101" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">tid</code></span><span class="SemanticString"> ：要等待线程之ID
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pcode_exit</code></span><span class="SemanticString"> ：如果非NULL，用于保存线程tid的退出代码</span></span></p></div><div id="https://www.notion.so/7bf872893877448aabe10dc80cb1972e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sample:</span></span></p></div><pre id="https://www.notion.so/663bdda0837c4d1bad2a52a5083ee34a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// Define thread function</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is task foo with tid=%d\\r\\n"</span><span class="token punctuation">,</span> <span class="token function">task_getid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// exit this task</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> st_Size <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token comment">// alloc user stack</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> stack_foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// create thread</span>
	<span class="token keyword">int</span> tid_foo <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stack_foo <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo<span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// waiting for the quiting of threads</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_foo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// release the memory</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stack_foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/67a65a83cea143448c61be2e59a834b5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/67a65a83cea143448c61be2e59a834b5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">随机数组生成</span></span></h3><pre id="https://www.notion.so/2978386f07374b5fa1b61889ea75d09f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">RandDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Use current time as seed for random generator</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//generate elements are between 0~max_Elem</span>
		array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> max_Elem<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/0a7d1cdd2cce40399d2cd26b27b12e1c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0a7d1cdd2cce40399d2cd26b27b12e1c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">图形模式API</span></span></h3><div id="https://www.notion.so/64530773ad6c4a16aa21e1fec4357582" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面说明本实验可能用到的API函数。
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">获取当前系统支持的图形模式</strong></span></span></p></div><pre id="https://www.notion.so/3448a4bde8924bd7a5dc03a0a2d01725" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">list_graphic_modes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/3e4679a267104cdb988a341b6ee41465" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">需在文本模式下运行才可看到结果。
老师PPT参考模式列表：</span></span></p></div><div id="https://www.notion.so/313be32b89dc4abf9533eb4085e66d1e" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/20d446609bc643c9abe0ac63fe8b2851" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">进入图形模式</strong></span></span></p></div><pre id="https://www.notion.so/450847101b5a4e63a7c6296999a1fe44" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">init_graphic</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/cd6bb5802e4b4cd38867c3a769f6a71c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">mode</code></span><span class="SemanticString">: 为上述图形模式对应的值，如</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int mode=0x100</code></span></span></p></div><div id="https://www.notion.so/46d42d11b12b486da1243b36820f328b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">获取屏幕的分辨率</strong></span><span class="SemanticString">
直接访问变量获取：
水平：</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_graphic_dev.XResolution</code></span><span class="SemanticString">
垂直：</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_graphic_dev.YResolution</code></span></span></p></div><blockquote id="https://www.notion.so/089e97bfdc234da2907e3a273720c7e2" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：g_graphic_dev在graphics.h中被声明为一个全局变量，使用时应包含此头文件。</span></span></blockquote><div id="https://www.notion.so/cf4886f458974328bb80066fbb574ef3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">打像素点</strong></span></span></p></div><pre id="https://www.notion.so/74a0a4d726bf47c99cf6ab31599e8470" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">setPixel</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> COLORREF cr<span class="token punctuation">)</span><span class="token punctuation">;</span> </span></span></span></code></pre><div id="https://www.notion.so/6c66470c1ff64a7d847e4a2d3f41c75c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(x, y)</code></span><span class="SemanticString">是像素点坐标
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cr</code></span><span class="SemanticString">是颜色，用宏定义</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">RGB(r,g,b)</code></span><span class="SemanticString">生成，其中r,g,b的取值范围都是0-255</span></span></p></div><div id="https://www.notion.so/6657fa7538c0498d878a750df9f00ac3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如何从cr中取出r,g,b？用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">getXValue(cr)</code></span><span class="SemanticString">，其中</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">X=R,G,B</code></span><span class="SemanticString">，如</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">getRValue(cr)</code></span><span class="SemanticString">取出cr的R分量值。</span></span></p></div><div id="https://www.notion.so/23fe6b5ec3a34747854c696c0c79d638" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">退出图形模式</strong></span></span></p></div><pre id="https://www.notion.so/4995b4c2ac1c48bdad138993e0445048" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> <span class="token function">exit_graphic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/9253b17297f34d98a1c5b65ef60b894d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9253b17297f34d98a1c5b65ef60b894d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">线程调度</span></span></h3><div id="https://www.notion.so/778ffc8834754d54a6a7d97186d6f064" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">优先级</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/ca868bd4aa514cedbf52a8de6ae192bb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">静态优先级(</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">)：内核不会修改它，不随时间而变化，除非用户通过系统调用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">setpriority</code></span><span class="SemanticString">进行修改。</span></span></li><li id="https://www.notion.so/19ae4744452746e3800eeedda4df21f0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">动态优先级(</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">priority</code></span><span class="SemanticString">)：内核根据线程使用CPU的状况、静态优先级nice和系统负荷计算出来，会随时间而变。作为最终的调度依据，即调度器只根据动态优先级进行调度。</span></span></li></ul><div id="https://www.notion.so/1f5880e600c846349671e245b2aab0ae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">线程数据结构</strong></span></span></p></div><div id="https://www.notion.so/1cbf0d5820a84cf0b58c37f398d4f661" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">epos的线程数据结构为单向链表：</span></span></p></div><div id="https://www.notion.so/45366ad82fe44a5bb6433c77687a3f65" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/c81d516a1b8b430a8cfdee1ec8cff422" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">注意：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/daf9a94c202643e783e2ba3d6f6313e7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在系统启动过程中，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_task_running</code></span><span class="SemanticString">是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NULL</code></span><span class="SemanticString">！</span></span></li><li id="https://www.notion.so/89692a1521484e04ba744a80416f3205" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">task0(tid=0)</code></span><span class="SemanticString">是系统空闲线程（system idle thread），当没有其他线程可运行时，才运行</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">task0</code></span><span class="SemanticString">!</span></span></li></ul><h3 id="https://www.notion.so/8869fd2084484f8d953d6dde3d8ef24f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8869fd2084484f8d953d6dde3d8ef24f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">关于定点数</span></span></h3><div id="https://www.notion.so/b063f1da475144a38dd2a4c9a8da991e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本次实验为追求性能采用了定点数去定义一部分变量。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/a61d67a3381b4e91921878a7cb50b797" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">浮点(float-point)表示 ：精度高，性能差！</span></span></li><li id="https://www.notion.so/c8f6617d68cb4bd8810ba87671749ed9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">定点(fixed-point)表示：精度低，性能好！</span></span></li></ul><blockquote id="https://www.notion.so/3d74b5c0c4cc44de8b63b5a3b7cc68ed" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：文件fixedptc.h中定义了定点数类型fixedpt及其运算，所以使用时需包含该头文件</span></span></blockquote><div id="https://www.notion.so/71ce90247c634f089902d0ad80e6500d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">另外，阅读往届学长的实验报告，发现代码中出现很多的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_mul(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_div(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_add(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_sub(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_fromint(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_toint(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">FIXEDPT_ONE</code></span><span class="SemanticString">……这是出于对性能的考虑。
但其中</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_add(,)</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt_sub(,)</code></span><span class="SemanticString">的宏定义如下：</span></span></p></div><pre id="https://www.notion.so/962e661b8af84ab2af93a513c19d56eb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">fixedpt_add</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">fixedpt_sub</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>B<span class="token punctuation">)</span></span></span></span></span></span></code></pre><div id="https://www.notion.so/dd279581a4d84da7ac2760917b075fd5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">因此定点加减法可直接使用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">+、-</code></span><span class="SemanticString">，因为没任何性能提升，反而让代码像a piece of shit。</span></span></p></div><h2 id="https://www.notion.so/1bebb44626ab4b5f89b486670598bfe8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1bebb44626ab4b5f89b486670598bfe8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验步骤</span></span></h2><h3 id="https://www.notion.so/4c27bc80f41e4f43831374dc2525aa8e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4c27bc80f41e4f43831374dc2525aa8e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">增加tcb属性nice</span></span></h3><div id="https://www.notion.so/ed02766ff9844a88b72ecf5333c1dfcf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">说明：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/936685af27f74b59a8cb371859ddec2b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">是整数，取值范围</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[-NZERO, NZERO-1]</code></span><span class="SemanticString">，值越小优先级越高</span></span></li><li id="https://www.notion.so/8e444c0f2bbe48faaf5c5a4c239dbbd7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">#define NZERO 20</code></span></span></li></ul><div id="https://www.notion.so/c62c88f1be5d4e2d9166664e667263d8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">①\kernel\kernel.h中，为线程数据结构</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">struct tcb</code></span><span class="SemanticString">线程的静态优先级</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">属性。</span></span></p></div><pre id="https://www.notion.so/56aaf6334d9249b4ab5193028269b594" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">tcb</span> <span class="token punctuation">{</span>
	……
    <span class="token keyword">struct</span> <span class="token class-name">fpu</span> fpu<span class="token punctuation">;</span> <span class="token comment">//数学协处理器的寄存器</span>
    <span class="token keyword">int</span> nice<span class="token punctuation">;</span>   <span class="token comment">//static priority</span>

    uint32_t signature<span class="token punctuation">;</span> <span class="token comment">//必须是最后一个字段</span>
	……
<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/c35cdf3dedd4465787da5cab88946c99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">②在\kernel\task.c中，函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_task_create</code></span><span class="SemanticString">中初始化</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice=0</code></span><span class="SemanticString">。</span></span></p></div><pre id="https://www.notion.so/a0eaf8694bab40eb8834a9e93ed5f5f1" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> <span class="token function">sys_task_create</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> tos<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	……
	new<span class="token operator">-></span>signature <span class="token operator">=</span> TASK_SIGNATURE<span class="token punctuation">;</span>

	new<span class="token operator">-></span>nice <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// initialize the static priority</span>
	……
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/3b2a294b609547229e00c7b59bd9da3b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/3b2a294b609547229e00c7b59bd9da3b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">增加系统调用</span></span></h3><div id="https://www.notion.so/92044b9888ef467192b9ef521c258e81" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用说明：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/f2c88cded714443186b17d62c8e358e2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int getpriority(int tid)</code></span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/1e1192f459484c25889fe54aa66c0be9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">成功返回(</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice+NZERO</code></span><span class="SemanticString">)，失败返回-1</span></span></li></ul></li><li id="https://www.notion.so/4c61b1f23d9b4a77a8a8f934ad93850f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int setpriority(int tid, int prio)</code></span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/eb8dddfe7edd425fb9005ef246667745" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">把线程tid的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">设为(</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">prio-NZERO</code></span><span class="SemanticString">)</span></span></li><li id="https://www.notion.so/10d21a14b74046c39809861d26b31c54" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">prio</code></span><span class="SemanticString">必须在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[0,2*NZERO-1]</code></span></span></li><li id="https://www.notion.so/1bee14c4419f46c1aee9cb143f0a562f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">成功返回0，失败返回-1</span></span></li></ul></li></ul><div id="https://www.notion.so/d4fee2fec7844fda8286c16697b28a35" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">①按照实验一，增加系统调用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">getpriority</code></span><span class="SemanticString"> ,</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">setpriority</code></span><span class="SemanticString">,
大致步骤略述：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/d6081f247bf84f3f9b6ff5f91057daa3" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\include\syscall.h</code></span><span class="SemanticString"> 声明系统调用API</span></span></li><li id="https://www.notion.so/c143ee0bd204451eaddabfc84f7f69ac" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\lib\syscall-wrapper.S</code></span><span class="SemanticString"> 定义封装例程</span></span></li><li id="https://www.notion.so/0f4f4a9f7b4c4f23971c2cbcd7130b4c" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\include\syscall-nr.h</code></span><span class="SemanticString"> 定义系统调用号</span></span></li><li id="https://www.notion.so/be861d0836e24980a07e909830655065" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\kernel.h</code></span><span class="SemanticString"> 声明系统调用服务例程函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_setpriority</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_getpriority</code></span></span></li><li id="https://www.notion.so/c4756b95f6e84eeeb6fced7e2776f7fd" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\machdep.c</code></span><span class="SemanticString"> 实现两个系统调用服务例程函数。</span></span></li><li id="https://www.notion.so/55705e2d116844819811f792ca9dbd24" class="NumberedList" value="6"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\machdep.c</code></span><span class="SemanticString"> 在系统调用分发函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">syscall()</code></span><span class="SemanticString">中根据系统调用号加入</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SYSCALL_xxx</code></span><span class="SemanticString">分支。</span></span></li></ol><div id="https://www.notion.so/a86bb137251143f6bb645418910be0a3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">②主要代码：
syscall()分发函数中添加分支：</span></span></p></div><pre id="https://www.notion.so/9fe116678eaf4eb5aa975edebacb9922" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">switch</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>eax<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	……
	<span class="token keyword">case</span> SYSCALL_getpriority<span class="token operator">:</span> 
	<span class="token punctuation">{</span>
		<span class="token keyword">int</span> ttid <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>esp <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ctx<span class="token operator">-></span>eax <span class="token operator">=</span> <span class="token function">sys_getpriority</span><span class="token punctuation">(</span>ttid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> SYSCALL_setpriority<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">int</span> ttid <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>esp <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> pprio <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>esp <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ctx<span class="token operator">-></span>eax <span class="token operator">=</span> <span class="token function">sys_setpriority</span><span class="token punctuation">(</span>ttid<span class="token punctuation">,</span> pprio<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	……
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/40c549c6274240d0844a1684adf885bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用服务例程函数的实现：</span></span></p></div><pre id="https://www.notion.so/f3d6e8b7d74a48beb0cd46aef9e2e911" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> <span class="token function">GetSelectedTcb</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> selected_Tcb<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// tid!=1</span>
		uint32_t flags<span class="token punctuation">;</span>
		<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// avoid interrupting</span>
		selected_Tcb <span class="token operator">=</span> g_task_head<span class="token punctuation">;</span>
		<span class="token comment">// find the tcb whose tid == tid</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>selected_Tcb <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>selected_Tcb<span class="token operator">-></span>tid <span class="token operator">==</span> tid<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			selected_Tcb <span class="token operator">=</span> selected_Tcb<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>  <span class="token comment">// tid==0,return current tcb</span>
		selected_Tcb <span class="token operator">=</span> g_task_running<span class="token punctuation">;</span>
	<span class="token keyword">return</span> selected_Tcb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">sys_getpriority</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> selected_Tcb <span class="token operator">=</span> <span class="token function">GetSelectedTcb</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> selected_Tcb <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> selected_Tcb<span class="token operator">-></span>nice <span class="token operator">+</span> NZERO <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_setpriority</span><span class="token punctuation">(</span><span class="token keyword">int</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> prio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> op_Result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// if failed,return -1, otherwise 0</span>
	<span class="token keyword">int</span> valid_Prio <span class="token operator">=</span> prio <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> prio <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> NZERO <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> selected_Tcb<span class="token punctuation">;</span>
	selected_Tcb <span class="token operator">=</span> valid_Prio <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token function">GetSelectedTcb</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	selected_Tcb <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token punctuation">(</span>selected_Tcb<span class="token operator">-></span>nice <span class="token operator">=</span> prio <span class="token operator">-</span> NZERO<span class="token punctuation">)</span>
						 <span class="token operator">:</span> <span class="token punctuation">(</span>op_Result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> op_Result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/d18ccfd0b38243d7ab036e81e558ece9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d18ccfd0b38243d7ab036e81e558ece9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">tcb增加动态优先级属性</span></span></h3><div id="https://www.notion.so/27f6b09c1f3549db8a473506cf823785" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">待增加的变量说明</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/ebadbec6284342d1b64d767664f04f51" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span><span class="SemanticString">-表示线程所用CPU时间，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt</code></span><span class="SemanticString">型，定时器中断会更新一次，并且每秒钟所有线程也会更新其</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span></span></li><li id="https://www.notion.so/7b5c7050ff774bfa92ff19ddffd0c01d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">priority</code></span><span class="SemanticString">-表示线程的动态优先级，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int</code></span><span class="SemanticString">型，范围0-127</span></span></li><li id="https://www.notion.so/7e9e9307e57d409eb72c7a25304d4beb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_load_avg</code></span><span class="SemanticString">-表示系统的平均负荷，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fixedpt</code></span><span class="SemanticString">型，每秒更新</span></span></li></ul><div id="https://www.notion.so/e8211ecd927d45ee9ee6abf85943601e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">更新规则：
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">estcpu</strong></span><span class="SemanticString">:</span></span></p></div><p id="https://www.notion.so/fa63283913ed44fca8ddbbe9adfc21f1" class="Equation" data-latex="estcpu \Leftarrow \frac{2\times g\_load\_avg}{2\times g\_load\_avg +1} \times estcpu+nice"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi><mo>⇐</mo><mfrac><mrow><mn>2</mn><mo>×</mo><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi></mrow><mrow><mn>2</mn><mo>×</mo><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>×</mo><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi><mo>+</mo><mi>n</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">estcpu \Leftarrow \frac{2\times g\_load\_avg}{2\times g\_load\_avg +1} \times estcpu+nice</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇐</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.39044em;vertical-align:-0.996em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.39444em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6999999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span></span></p><div id="https://www.notion.so/c2da977cfa4449b98fee21d0afa205cf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">
可化为
</span></span></p></div><p id="https://www.notion.so/68cf167769c843848aaafb1db0a3af9b" class="Equation" data-latex="estcpu \Leftarrow estcpu-\frac{estcpu}{2\times g\_load\_avg +1}+nice"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi><mo>⇐</mo><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi><mo>−</mo><mfrac><mrow><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi></mrow><mrow><mn>2</mn><mo>×</mo><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>+</mo><mi>n</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">estcpu \Leftarrow estcpu-\frac{estcpu}{2\times g\_load\_avg +1}+nice</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇐</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.28808em;vertical-align:-0.996em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span></span></p><div id="https://www.notion.so/2ab9ada0ff7347c7bc28369ff203f764" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">prority</strong></span><span class="SemanticString">:
</span></span></p></div><p id="https://www.notion.so/e93b3ffc6bb440f4bfbd8101a12afe3b" class="Equation" data-latex="prority \Leftarrow PRI\_USER\_MAX-\frac{estcpu}{4}-2\times nice"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo>⇐</mo><mi>P</mi><mi>R</mi><mi>I</mi><mi mathvariant="normal">_</mi><mi>U</mi><mi>S</mi><mi>E</mi><mi>R</mi><mi mathvariant="normal">_</mi><mi>M</mi><mi>A</mi><mi>X</mi><mo>−</mo><mfrac><mrow><mi>e</mi><mi>s</mi><mi>t</mi><mi>c</mi><mi>p</mi><mi>u</mi></mrow><mn>4</mn></mfrac><mo>−</mo><mn>2</mn><mo>×</mo><mi>n</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">prority \Leftarrow PRI\_USER\_MAX-\frac{estcpu}{4}-2\times nice</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇐</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.99333em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.9780799999999998em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span></span></span></span></span></p><div id="https://www.notion.so/636841725ae948c49721db583af7c25e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">g_load_avg</strong></span><span class="SemanticString">:
</span></span></p></div><p id="https://www.notion.so/ba1d7e22d879492986231ee9fa107475" class="Equation" data-latex="g\_load\_avg \Leftarrow \frac{59}{60}\times g\_load\_avg+\frac{1}{60}\times nready"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>⇐</mo><mfrac><mn>59</mn><mn>60</mn></mfrac><mo>×</mo><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>+</mo><mfrac><mn>1</mn><mn>60</mn></mfrac><mo>×</mo><mi>n</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">g\_load\_avg \Leftarrow \frac{59}{60}\times g\_load\_avg+\frac{1}{60}\times nready</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇐</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span></span></p><div id="https://www.notion.so/33d076861816463cb56878693b19823b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">
可化为
</span></span></p></div><p id="https://www.notion.so/a6bff93197a943d1aa4cf02a59c04d48" class="Equation" data-latex="g\_load\_avg \Leftarrow g\_load\_avg-\frac{g\_load\_avg}{60}+\frac{ nready}{60}"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>⇐</mo><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi><mo>−</mo><mfrac><mrow><mi>g</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>v</mi><mi>g</mi></mrow><mn>60</mn></mfrac><mo>+</mo><mfrac><mrow><mi>n</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>y</mi></mrow><mn>60</mn></mfrac></mrow><annotation encoding="application/x-tex">g\_load\_avg \Leftarrow g\_load\_avg-\frac{g\_load\_avg}{60}+\frac{ nready}{60}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇐</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.08044em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.39444em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6999999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.0574399999999997em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><div id="https://www.notion.so/c3d14349968645ea8e083e339443bf9e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f43c3c2d62334072bfadafa024ccbf46" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">①在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">struct tcb</code></span><span class="SemanticString">中，增加两个属性</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span><span class="SemanticString">, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">priority</code></span><span class="SemanticString">，头部声明一个全局变量</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_load_avg</code></span><span class="SemanticString">
\kernel\kernel.h中：
在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">属性后插入</span></span></p></div><pre id="https://www.notion.so/47c68952b384492287406a825bfd6d17" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">int</span> nice<span class="token punctuation">;</span>   <span class="token comment">//static priority  </span>
fixedpt estcpu<span class="token punctuation">;</span> <span class="token comment">//record the time of using cpu  </span>
<span class="token keyword">int</span> priority<span class="token punctuation">;</span>   <span class="token comment">//the priority of thread  </span></span></span></span></code></pre><div id="https://www.notion.so/ee9413cea0c047359e45bc8fd446374a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">头部需声明：</span></span></p></div><pre id="https://www.notion.so/313756001f714985963469ae8d7dae33" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"fixedptc.h"</span>      </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">NZERO <span class="token number">20</span>    </span><span class="token comment">//The bound of static priority  </span></span>
fixedpt g_load_avg<span class="token punctuation">;</span> <span class="token comment">//System average load  </span></span></span></span></code></pre><div id="https://www.notion.so/df48dd07f440462cb98cffbb6f19e797" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在\kernel\task.c中：
头部声明：</span></span></p></div><pre id="https://www.notion.so/0a31737be66240499417854f5aeeb36d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">PRI_USER_MIN <span class="token number">0</span>  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">PRI_USER_MAX <span class="token number">127</span>  </span></span></span></span></span></code></pre><div id="https://www.notion.so/cc292592088e4e678e7a3d96b8d10bdb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">②在函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_task_create</code></span><span class="SemanticString">中</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">new-&gt;nice=0</code></span><span class="SemanticString">后初始化</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu=0</code></span></span></p></div><pre id="https://www.notion.so/8bc18d8029c14df491ac3a7288675403" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>new<span class="token operator">-></span>nice <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// initialize the static priority  </span>
new<span class="token operator">-></span>estcpu <span class="token operator">=</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
new<span class="token operator">-></span>priority <span class="token operator">=</span>  
    PRI_USER_MAX<span class="token punctuation">;</span>  <span class="token comment">// new->priority=PRI_USER_MAX-(estcpu/4)-(nice*2);  </span>
                   <span class="token comment">// initial the dynamic priority </span></span></span></span></code></pre><div id="https://www.notion.so/2ea9d78acb64447785b0d1606837c8a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">③在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">init_task()</code></span><span class="SemanticString">中初始化</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_load_avg</code></span></span></p></div><pre id="https://www.notion.so/86b0c18ea3fa4e42b6fd7bcd9432608a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">init_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        ……  
    g_task_own_fpu <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
  
    g_load_avg <span class="token operator">=</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ……  
<span class="token punctuation">}</span>  </span></span></span></code></pre><div id="https://www.notion.so/cd6d0455d5274a20a9949d8baad2108d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">④每次定时器中断更新</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span><span class="SemanticString">和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_load_avg</code></span><span class="SemanticString">：
在\kernel\timer.c中</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">isr_timer()</code></span><span class="SemanticString">函数前添加</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">UpdateEstcpu()</code></span><span class="SemanticString">实现每秒为所有线程（运行、就绪和等待）更新</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span><span class="SemanticString">和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_load_avg</code></span><span class="SemanticString">，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">isr_timer()</code></span><span class="SemanticString">中每次定时器中断更新</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">estcpu</code></span><span class="SemanticString">，其中</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">g_timer_ticks % HZ == 0</code></span><span class="SemanticString">表示已过1秒，此时应调用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">UpdateEstcpu()</code></span></span></p></div><pre id="https://www.notion.so/ff2ddc842bc74bb49fa444cf63270c0f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">/**Update estcpu*/</span>
<span class="token keyword">void</span> <span class="token function">UpdateEstcpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> nready <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> p_Tcb <span class="token operator">=</span> g_task_head<span class="token punctuation">;</span> <span class="token comment">//point to some tcb in the linked list</span>

    fixedpt deno <span class="token operator">=</span> g_load_avg <span class="token operator">+</span> g_load_avg <span class="token operator">+</span> FIXEDPT_ONE<span class="token punctuation">;</span> <span class="token comment">//the denominator of ratio as estcpu updating</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>p_Tcb <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//count the num of thread in ready queue</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p_Tcb <span class="token operator">!=</span> task0 <span class="token operator">&amp;&amp;</span> p_Tcb<span class="token operator">-></span>state <span class="token operator">==</span> TASK_STATE_READY<span class="token punctuation">)</span>
            nready<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">//update estcpu</span>
        p_Tcb<span class="token operator">-></span>estcpu <span class="token operator">=</span> p_Tcb<span class="token operator">-></span>estcpu
            <span class="token operator">-</span> <span class="token function">fixedpt_div</span><span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>estcpu<span class="token punctuation">,</span> deno<span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p_Tcb <span class="token operator">=</span> p_Tcb<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//update the average load</span>
    g_load_avg <span class="token operator">=</span> g_load_avg
        <span class="token operator">-</span> <span class="token function">fixedpt_div</span><span class="token punctuation">(</span>g_load_avg<span class="token punctuation">,</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">fixedpt_div</span><span class="token punctuation">(</span><span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span>nready<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 定时器的中断处理程序
 */</span>
<span class="token keyword">void</span> <span class="token function">isr_timer</span><span class="token punctuation">(</span>uint32_t irq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">context</span><span class="token operator">*</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    g_timer_ticks<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">//sys_putchar('.');</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_task_running <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果是task0在运行，则强制调度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>g_task_running<span class="token operator">-></span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            g_resched <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//否则，把当前线程的时间片减一</span>
            <span class="token operator">--</span>g_task_running<span class="token operator">-></span>timeslice<span class="token punctuation">;</span>

            <span class="token comment">//update estcpu for every timer tick</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_task_running <span class="token operator">!=</span> task0<span class="token punctuation">)</span>
                g_task_running<span class="token operator">-></span>estcpu <span class="token operator">=</span> g_task_running<span class="token operator">-></span>estcpu <span class="token operator">+</span> FIXEDPT_ONE<span class="token punctuation">;</span>

            <span class="token comment">//如果当前线程用完了时间片，也要强制调度</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g_task_running<span class="token operator">-></span>timeslice <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                g_resched <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g_task_running<span class="token operator">-></span>timeslice <span class="token operator">=</span> TASK_TIMESLICE_DEFAULT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//one second has gone</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_timer_ticks <span class="token operator">%</span> HZ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">UpdateEstcpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/99e9f334d2df4db788c0a08a1b2c2124" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/99e9f334d2df4db788c0a08a1b2c2124"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">优先级调度算法</span></span></h3><div id="https://www.notion.so/3e951e611eef49eeac981fe45c34a6da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">调度算法：</strong></span><span class="SemanticString">
①线程链表中仅有task0 ? (切换到task0，重新调度) : ②
②队首为task0 ? (从g_task_head-&gt;next开始遍历，然后③) : (从g_task_head开始遍历，然后③)
③从遍历列表中找出最大优先级的tcb，同时更新priority（除task0）
④切换到选中的tcb，重新调度</span></span></p></div><div id="https://www.notion.so/d33e40562cd34a399de3e3ce63b74b79" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">算法实现：</strong></span><span class="SemanticString">
修改\kernel\task.c中的函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">schedule()</code></span><span class="SemanticString">，实现优先级调度算法。
附上修改后的代码，说明见注释：</span></span></p></div><pre id="https://www.notion.so/61522cb1429b446fbf01aeeca113ed91" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">/**
 *  Calculate the priority,
 *  Find the highest-priority thread, return it
 *  Maybe there's only task0, return it
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> <span class="token function">SelectedTcb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> p_Tcb<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> maxprio_Tcb<span class="token punctuation">;</span>
	maxprio_Tcb <span class="token operator">=</span> p_Tcb <span class="token operator">=</span> g_task_head<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Tcb <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// update the priority</span>
		p_Tcb<span class="token operator">-></span>priority <span class="token operator">=</span>
			PRI_USER_MAX <span class="token operator">-</span>
			<span class="token function">fixedpt_toint</span><span class="token punctuation">(</span><span class="token function">fixedpt_div</span><span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>estcpu<span class="token punctuation">,</span> <span class="token function">fixedpt_fromint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>
			p_Tcb<span class="token operator">-></span>nice <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>priority <span class="token operator">&lt;</span> PRI_USER_MIN<span class="token punctuation">)</span> p_Tcb<span class="token operator">-></span>priority <span class="token operator">=</span> PRI_USER_MIN<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>priority <span class="token operator">></span> PRI_USER_MAX<span class="token punctuation">)</span> p_Tcb<span class="token operator">-></span>priority <span class="token operator">=</span> PRI_USER_MAX<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Tcb <span class="token operator">!=</span> task0<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Tcb<span class="token operator">-></span>priority <span class="token operator">>=</span>
					maxprio_Tcb
						<span class="token operator">-></span>priority <span class="token operator">&amp;&amp;</span>  <span class="token comment">// search the highest-priority thread</span>
				p_Tcb<span class="token operator">-></span>state <span class="token operator">==</span> TASK_STATE_READY<span class="token punctuation">)</span>
				maxprio_Tcb <span class="token operator">=</span> p_Tcb<span class="token punctuation">;</span>
		p_Tcb <span class="token operator">=</span> p_Tcb<span class="token operator">-></span>next<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> maxprio_Tcb<span class="token punctuation">;</span>  <span class="token comment">// return the max prio one, maybe task0</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * CPU调度器函数
 *
 * 注意：该函数的执行不能被中断
 */</span>
<span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">tcb</span><span class="token operator">*</span> select <span class="token operator">=</span> <span class="token function">SelectedTcb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>select <span class="token operator">==</span> g_task_running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>select<span class="token operator">-></span>state <span class="token operator">==</span> TASK_STATE_READY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		select <span class="token operator">=</span> task0<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// printk("0x%d -> 0x%d\\r\\n", (g_task_running == NULL) ? -1 :</span>
	<span class="token comment">// g_task_running->tid, select->tid);</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>select<span class="token operator">-></span>signature <span class="token operator">!=</span> TASK_SIGNATURE<span class="token punctuation">)</span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"warning: kernel stack of task #%d overflow!!!"</span><span class="token punctuation">,</span> select<span class="token operator">-></span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	g_resched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">switch_to</span><span class="token punctuation">(</span>select<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/c4974f72bfa14a6bad19e8bcfa14526d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c4974f72bfa14a6bad19e8bcfa14526d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">测试调度器</span></span></h3><div id="https://www.notion.so/9c90a9b95c144bc9b06d64e593bc6cbc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">后面的工作就是创建线程、定义线程函数、折腾画图函数等操作，不做介绍，直接贴代码。
main.c函数中：</span></span></p></div><pre id="https://www.notion.so/b3118e7e641443cea537a96935146e44" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>……
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"graphics.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lab3.h"</span></span>
……
<span class="token comment">/**
 * 第一个运行在用户模式的线程所执行的函数
 */</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"task #%d: I'm the first user task(pv=0x%08x)!\\r\\n"</span><span class="token punctuation">,</span> <span class="token function">task_getid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		   pv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// TODO: Your code goes here</span>
    <span class="token function">test_lab3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">;</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/99b55dc4fe7b41ffaf19f34b49d52c6a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">lab3.h</span></span></p></div><pre id="https://www.notion.so/f779a02678a1458ea7b0016f9ca50654" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_LAB3_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">_LAB3_</span></span>
<span class="token comment">/*
#include &lt;inttypes.h>
#include &lt;math.h>
#include &lt;netinet/in.h>
#include &lt;stddef.h>
#include &lt;stdio.h>
#include &lt;stdlib.h>
#include &lt;sys/mman.h>
#include &lt;syscall.h>
#include "graphics.h"
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">ar_Size <span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">max_Elem <span class="token number">300</span></span></span>
uint16_t w_Line<span class="token punctuation">;</span>
uint16_t l_Ratio<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Thr</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> prio<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> LorR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uint16_t x <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>XResolution <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> sign <span class="token operator">=</span> LorR<span class="token punctuation">;</span>
	COLORREF cr<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sign <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">78</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token function">setPixel</span><span class="token punctuation">(</span>x <span class="token operator">+</span> sign <span class="token operator">*</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">78</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
			<span class="token function">setPixel</span><span class="token punctuation">(</span>x <span class="token operator">+</span> sign <span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token number">78</span> <span class="token operator">-</span> j<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">78</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token function">setPixel</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">tsk_foo_control</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> key<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">Thr</span><span class="token operator">*</span> th <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Thr</span><span class="token operator">*</span><span class="token punctuation">)</span>pv<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_A <span class="token operator">=</span> th<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> prio_A <span class="token operator">=</span> th<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>prio<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_B <span class="token operator">=</span> th<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> prio_B <span class="token operator">=</span> th<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>prio<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		key <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x4800</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// UP</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prio_A <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prio_A <span class="token operator">&lt;=</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token operator">--</span>prio_A<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x5000</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// DOWN</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prio_A <span class="token operator">>=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prio_A <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token operator">++</span>prio_A<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4d00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// RIGHT</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prio_B<span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prio_B <span class="token operator">&lt;=</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token operator">--</span>prio_B<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4b00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// LEFT</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>prio_B <span class="token operator">>=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prio_B <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token operator">++</span>prio_B<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  create 2 arrays</span>
<span class="token keyword">void</span> <span class="token function">Generate2arrays</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> ar_1<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> ar_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">float</span> x_Begin <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>XResolution <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ar_1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ar_2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> max_Elem<span class="token punctuation">;</span>
		<span class="token comment">// draw lines</span>
		<span class="token function">line</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">*</span> w_Line<span class="token punctuation">,</span> ar_1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio<span class="token punctuation">,</span> i <span class="token operator">*</span> w_Line<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">line</span><span class="token punctuation">(</span>x_Begin <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">,</span> i <span class="token operator">*</span> w_Line<span class="token punctuation">,</span> x_Begin <span class="token operator">+</span> <span class="token number">28</span> <span class="token operator">+</span> ar_1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio<span class="token punctuation">,</span>
			 i <span class="token operator">*</span> w_Line<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">78</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token function">setPixel</span><span class="token punctuation">(</span>x_Begin <span class="token operator">+</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> g_graphic_dev<span class="token punctuation">.</span>YResolution<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
		<span class="token function">setPixel</span><span class="token punctuation">(</span>x_Begin<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// set time delay for thread action</span>
<span class="token keyword">void</span> <span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token keyword">long</span> lMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">long</span> lRemainingMilliSecond <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> lNanoSecond <span class="token operator">=</span> lRemainingMilliSecond <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timespec</span> ts_sleep<span class="token punctuation">,</span> ts_remaining<span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> lNanoSecond<span class="token punctuation">;</span>
	<span class="token function">nanosleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_sleep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts_remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// swap two elements and draw the lines</span>
<span class="token keyword">void</span> <span class="token function">SwapLine</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> area_Num<span class="token punctuation">,</span> <span class="token keyword">int</span> a_lineNum<span class="token punctuation">,</span> <span class="token keyword">int</span> b_lineNum<span class="token punctuation">,</span>
			  COLORREF cr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> l_fixed <span class="token operator">=</span> <span class="token number">28</span> <span class="token operator">*</span> area_Num<span class="token punctuation">;</span>
	<span class="token keyword">int</span> r_fixed <span class="token operator">=</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token punctuation">(</span>area_Num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0</span><span class="token punctuation">;</span>
	uint16_t x_Begin <span class="token operator">=</span> area_Num <span class="token operator">*</span> g_graphic_dev<span class="token punctuation">.</span>XResolution <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> l_fixed<span class="token punctuation">;</span>
	<span class="token function">line</span><span class="token punctuation">(</span>x_Begin<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 x_Begin <span class="token operator">+</span> array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio <span class="token operator">+</span> r_fixed<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">line</span><span class="token punctuation">(</span>x_Begin<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 x_Begin <span class="token operator">+</span> array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio <span class="token operator">+</span> r_fixed<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">line</span><span class="token punctuation">(</span>x_Begin<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 x_Begin <span class="token operator">+</span> array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio <span class="token operator">+</span> r_fixed<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">line</span><span class="token punctuation">(</span>x_Begin<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 x_Begin <span class="token operator">+</span> array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> l_Ratio <span class="token operator">+</span> r_fixed<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> w_Line<span class="token punctuation">,</span>
		 cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tmp <span class="token operator">=</span> array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
	<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">tsk_foo_BubbleSort_1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>pv<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> ar_Size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token function">SwapLine</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">tsk_foo_BubbleSort_2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>pv<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> ar_Size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token function">SwapLine</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test_lab3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// declare 2 arrays</span>
	<span class="token keyword">int</span> arr1<span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> arr2<span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// enter the gui</span>
	<span class="token keyword">int</span> graphMode <span class="token operator">=</span> <span class="token number">0x143</span><span class="token punctuation">;</span>
	<span class="token function">init_graphic</span><span class="token punctuation">(</span>graphMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// calculate the ratio(maybe there's no need to do these)</span>
	l_Ratio <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>XResolution <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">/</span> max_Elem<span class="token punctuation">;</span>
	w_Line <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>YResolution <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>ar_Size<span class="token punctuation">;</span>
	<span class="token comment">// generate 2 arrays and draw!</span>
	<span class="token function">Generate2arrays</span><span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// alloc stack size</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> st_Size <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token comment">// create 2 sort threads</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> stack_Sort1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_Sort1 <span class="token operator">=</span>
		<span class="token function">task_create</span><span class="token punctuation">(</span>stack_Sort1 <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_BubbleSort_1<span class="token punctuation">,</span> arr1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> stack_Sort2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_Sort2 <span class="token operator">=</span>
		<span class="token function">task_create</span><span class="token punctuation">(</span>stack_Sort2 <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_BubbleSort_2<span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initial the priorities</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Sort1<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Sort2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_Sort1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_Sort2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// create the control thread</span>
	<span class="token keyword">struct</span> <span class="token class-name">Thr</span> th<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>tid_Sort1<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>tid_Sort2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> stack_Ctr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_Ctr <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stack_Ctr <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_control<span class="token punctuation">,</span> th<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nice = -19</span>

	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Sort1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Sort2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stack_Sort1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stack_Sort2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stack_Ctr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Mession Success, Well Done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">//_LAB3_</span></span></span></span></span></code></pre><div id="https://www.notion.so/2df1f8b041604ac8a577fd17b1a9caf3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/8fca5423c47742c7894159071fa0fd10" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8fca5423c47742c7894159071fa0fd10"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验结果</span></span></h2><div id="https://www.notion.so/f494328f142644deb5822c9f33d441a5" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/0cbe148298ea4c769fde7eaf5d3382fa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0cbe148298ea4c769fde7eaf5d3382fa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/fb679076f61e4598b3aaea42584ac2f6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">编程时对性能更加注重</span></span></li><li id="https://www.notion.so/97cc91dc78cc4987ba427e3660864d23" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对线程的调度有初步认识</span></span></li><li id="https://www.notion.so/faf4ed13a9464759bdd6906d40a9882e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">温故了C，感觉自己的C越来越垃圾</span></span></li><li id="https://www.notion.so/191028e1f88f41b5a049fa7c2c42a804" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">不足：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/68c2dd90c8794638956beec40e4abe2a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">实验中对</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nice</code></span><span class="SemanticString">以及</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">priority</code></span><span class="SemanticString">属性的范围未做显式约束</span></span></li><li id="https://www.notion.so/c68e7b5eef07408092926901a9af0f1a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">神奇的bug是，main()中添加</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">task_wait()</code></span><span class="SemanticString">会提前结束线程，推测调度算法有缺陷，产生于无边界约束，后期修正。（已修正）</span></span></li></ul></li></ul><div id="https://www.notion.so/0c2de57390cd40f7a255690be0da24c9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">若有时间，计划折腾其他调度算法。</span></span></p></div><div id="https://www.notion.so/f52b739684b0461b86541412088109f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">感谢：林坤、王凯学长！</span></span></p></div></article>  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: 'x3yNlOp8snKVbHLuM3MDgyPm-gzGzoHsz',
      appKey: 'IxbPmtJ4C181kqwCPyUfHb67',
      avatar: 'retro',
      placeholder: 'Welcome to comment here233!',
      requiredFields: ['nick', 'mail']
    })
  </script>
  <footer class="Footer">
    <div>&copy; idzc.me 2020</div>
    <div>&centerdot;</div>
    <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
        rel="noopener noreferrer">Notablog</a>.
    </div>
  </footer>
</body>

</html>
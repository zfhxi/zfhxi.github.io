{"componentChunkName":"component---plugins-gine-theme-mod-src-components-post-tag-tag-page-js","path":"/tags/操作系统","result":{"data":{"allPosts":{"edges":[{"node":{"description":"最近刚做了最后一次实验，实现多线程同步（多线程对同一个缓冲区的使用问题），涉及到信号量的设计，这正是我知识点盲区……","html":"<div data-block-id=\"ecb5aa57-7bdf-4b2a-a81a-c871337b8a25\" class=\"notion-selectable notion-table_of_contents-block\" style=\"width: 100%; max-width: 608px; margin-top: 2px; margin-bottom: 4px;\"><div style=\"position: relative;\"><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#5bafc167-2d49-470a-9bd4-7678786250d1\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">实验内容</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#1056681e-b050-4c4e-9c88-8575947fbc0b\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">实现信号量</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#1366985a-ea25-4736-b8b0-ca15b4f07adb\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">设计生产者/消费者</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#1a61bb4c-b882-44cd-b9e4-75c4dbfcf4ae\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">预备知识</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#3f2908f2-5991-4cb5-a2e7-49a765c0ced0\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">信号量</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#be2f9de2-c83a-4a5d-9760-b6a3b77ba689\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">线程睡眠/唤醒API</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#8e7af827-75d7-43d4-9b08-4bc107cc14fb\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">实验步骤</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#1f8297c7-d998-4d0e-929f-4db84c29be5d\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">信号量系统调用实现</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#c4ef21e6-fe48-47ea-bbff-be0644603627\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">生产者/消费者设计</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#5dda3b39-ec0f-4cf4-b500-3446afca8485\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">实验结果</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#09bb552d-accb-459f-87b5-e9d9361e9173\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">感谢</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#32bfa939-c963-47b4-839f-02f2e73fa974\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">代码附录</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#77aeacd2-011c-434c-9da9-90c70502807d\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">main.c</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#29e9f967-adf1-4fec-ab03-dd44cfc6438a\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">lab4.h</div></div></div></a></div></div></div><div data-block-id=\"f93bd842-a014-4f11-ae63-6ec9b84d6231\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">最近刚做了最后一次实验，实现多线程同步（多线程对同一个缓冲区的使用问题），涉及到信号量的设计，这正是我知识点盲区，所以写得有点久了。</div></div></div></div><div data-block-id=\"1745d482-fe87-41db-86a4-204be290981c\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">于是参考此处，略补了一点知识：<a href=\"https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"1\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\">https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore</span></a></div></div></div></div><div data-block-id=\"9c76d650-3978-42a3-8174-e419e2bbf539\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">下面进入正题（开始抄老师ppt）。</div></div></div></div><div data-block-id=\"5bafc167-2d49-470a-9bd4-7678786250d1\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"5bafc167-2d49-470a-9bd4-7678786250d1\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">实验内容</div></div></div><div data-block-id=\"1056681e-b050-4c4e-9c88-8575947fbc0b\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"1056681e-b050-4c4e-9c88-8575947fbc0b\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">实现信号量</div></div></div><div data-block-id=\"867ba6dd-9a5a-427b-a59b-42ee680d83cf\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">编辑文件kernel/sem.c，实现如下四个函数\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">int sys_sem_create(int value)value</span>是信号量的初值\n分配内存要用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"3\">kmalloc</span>，不能用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"5\">malloc</span>！\n成功返回信号量ID，否则返回-1\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"7\">int sys_sem_destroy(int semid)</span>\n释放内存要用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"9\">kfree</span>，不能用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"11\">free</span>！\n成功返回0，否则返回-1\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"13\">int sys_sem_wait(int semid)</span>\nP操作，要用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"15\">save_flags_cli</span>/<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"17\">restore_flags</span>和函数<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"19\">sleep_on</span>\n成功返回0，否则返回-1\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"21\">int sys_sem_signal(int semid)</span>\nV操作，要用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"23\">save_flags_cli</span>/<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"25\">restore_flags</span>和函数<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"27\">wake_up</span>\n成功返回0，否则返回-1\n把这四个函数做成系统调用，分别是<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"29\">sem_create/destroy/wait/signal</span></div></div></div></div><div data-block-id=\"1366985a-ea25-4736-b8b0-ca15b4f07adb\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"1366985a-ea25-4736-b8b0-ca15b4f07adb\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">设计生产者/消费者</div></div></div><div data-block-id=\"ef8476ef-5f68-4a89-b3e1-d5a4dc08caaa\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">①在图形模式下将屏幕沿垂直方向分成N份，作为N个缓冲区。其次，创建两个线程，其中一个是生产者，负责生成随机数并填到缓冲区中；另一个线程是消费者，负责把缓冲区中的随机数进行排序</div></div><div data-block-id=\"45cea482-be47-4d48-8414-8b0708ab0470\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 2px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">生产者生成随机数后，要画到缓冲区</div></div></div></div></div><div data-block-id=\"3df2277f-de3a-4188-b930-2e8affd8b33a\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 1px; margin-bottom: 0px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">消费者完成排序之后，要清除缓冲区</div></div></div></div></div></div></div></div><div data-block-id=\"9c41863c-591b-4eeb-8acb-ec9fe02e8254\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">②创建一个控制线程，用键up/down控制生产者的优先级，用键right/left控制消费者的优先级</div></div><div data-block-id=\"503c7bd6-0d18-449e-a54f-7b3de5a3d1ac\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 2px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">把控制线程的静态优先级设置到最高，以保证控制效果</div></div></div></div></div><div data-block-id=\"685510de-6cfd-45be-888f-1303df57c190\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 1px; margin-bottom: 0px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">在屏幕上用进度条动态显示生产者和消费者的静态优先级</div></div></div></div></div></div></div></div><div data-block-id=\"1a61bb4c-b882-44cd-b9e4-75c4dbfcf4ae\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"1a61bb4c-b882-44cd-b9e4-75c4dbfcf4ae\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">预备知识</div></div></div><div data-block-id=\"3f2908f2-5991-4cb5-a2e7-49a765c0ced0\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"3f2908f2-5991-4cb5-a2e7-49a765c0ced0\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">信号量</div></div></div><div data-block-id=\"58c816d4-8d90-4466-b549-a8ff1d410440\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\"><span style=\"font-weight:600\" data-token-index=\"0\">关于信号量</span>\n可以参考文章:<a href=\"https://github.com/Wangzhike/HIT-Linux-0.11/blob/master/5-semaphore/%20Linux%200.11%E4%B8%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E5%BA%94%E7%94%A8.md\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"2\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\"> Linux 0.11下信号量的实现和应用</span></a></div></div></div></div><div data-block-id=\"d2d94daa-a36e-477a-8c47-e05b79de0e24\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\"><span style=\"font-weight:600\" data-token-index=\"0\">EPOS互斥</span></div></div></div></div><div data-block-id=\"246a8645-2d9c-4eac-b1aa-c4e5241a688d\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">EPOS运行于单CPU的计算机上 –内核可以用开关中断实现互斥</div></div></div></div></div><div data-block-id=\"bdf3b6e8-6d92-450f-bc0a-1247687d735e\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">中断的开关由EFLAGS中的IF位决定，指令如下：</div></div><div data-block-id=\"07278876-4ccc-47c0-aa67-ed19b3d22ba5\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 2px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">sti，IF=1 中断打开</div></div></div></div></div><div data-block-id=\"1c6fa2a6-7307-4df2-af74-78a6d08804dc\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 100%; margin-top: 1px; margin-bottom: 0px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">cli，IF=0 中断关闭</div></div></div></div></div></div></div></div><div data-block-id=\"0b1be8de-97aa-445f-a9d2-74dad4976d20\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">EFLAGS组成如下：</div></div></div></div><div data-block-id=\"0db171f2-6f0c-4c4d-9d61-6011a48b005b\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F4%2F22%2F1555915526869.png?table=block&amp;id=0db171f2-6f0c-4c4d-9d61-6011a48b005b&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"e6804db8-6bdc-4db1-a9f0-752908d2e941\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">EPOS提供的中断API：</div></div></div></div><div data-block-id=\"5893c0f3-c086-41d8-94f4-e59fd4d55c89\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">保存EFLAGS的值到一个变量flags中，然后IF=0\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">save_flags_cli(flags)</span></div></div></div></div></div><div data-block-id=\"d6cb00a5-1568-430e-878a-418f9266ab06\" class=\"notion-selectable notion-bulleted_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><div style=\"font-size: 1.5em; line-height: 1; margin-bottom: 0.1em;\">•</div></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\">把变量flags的值恢复到EFLAGS中\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">restore_flags(flags)</span></div></div></div></div></div><div data-block-id=\"130b5d3b-aa73-4579-b73c-c63b6a2f8410\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">Sample:</div></div></div></div><div data-block-id=\"03bc79ee-e070-485a-9e0a-a854f88f1f25\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span data-token-index=\"0\">uint32_t flags</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token function\" data-token-index=\"0\">save_flags_cli</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n临界区\n\n</span><span class=\"token function\" data-token-index=\"0\">restore_flags</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"be2f9de2-c83a-4a5d-9760-b6a3b77ba689\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"be2f9de2-c83a-4a5d-9760-b6a3b77ba689\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">线程睡眠/唤醒API</div></div></div><div data-block-id=\"a222d74d-4e39-4a4d-925e-b59a2c23f261\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\"><span style=\"font-weight:600\" data-token-index=\"0\">睡眠</span><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">void sleep_on(struct wait_queue **head)</span>\n参数head是睡眠队列的头指针\n<span style=\"font-weight:600\" data-token-index=\"3\">唤醒</span><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"4\">void wake_up(struct wait_queue **head, int n)</span>\n参数n表示要唤醒的线程个数，n小于0表示唤醒该队列中的所有线程\n<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"6\">sleep_on</span>和<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"8\">wake_up</span>必须在关中断环境中运行，即用<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"10\">save_flags_cli</span>/<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"12\">restore_flags</span>保护</div></div></div></div><div data-block-id=\"7d3aa6e3-adf2-4c3a-80bb-305ac399386b\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">Sample:</div></div></div></div><div data-block-id=\"ce45e3cc-a714-4de0-ae38-05c0c5644235\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">wait_queue</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">wq_kbd </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span class=\"token comment\" data-token-index=\"0\">//!!!非常重要!!!</span><span data-token-index=\"0\">\nuint16_t   buf_kbd</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token comment\" data-token-index=\"0\">//从键盘读按键信息</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_getchar</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n     uint32_t flags</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n     </span><span class=\"token function\" data-token-index=\"0\">save_flags_cli</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n     \n     </span><span class=\"token comment\" data-token-index=\"0\">//睡眠等待用户按键</span><span data-token-index=\"0\">\n     </span><span class=\"token function\" data-token-index=\"0\">sleep_on</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span data-token-index=\"0\">wq_kbd</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n     \n     </span><span class=\"token function\" data-token-index=\"0\">restore_flags</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n     </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> buf_kbd</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n</span><span class=\"token comment\" data-token-index=\"0\">//键盘中断处理函数</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">isr_keyboard</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">uint32_t irq</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">context</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">ctx</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n     buf_kbd </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">read_data_from_kbd</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n      \n     </span><span class=\"token comment\" data-token-index=\"0\">//注意：在ISR中，中断已经被关闭</span><span data-token-index=\"0\">\n     </span><span class=\"token comment\" data-token-index=\"0\">//唤醒1个等待用户按键的线程</span><span data-token-index=\"0\">\n     </span><span class=\"token function\" data-token-index=\"0\">wake_up</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span data-token-index=\"0\">wq_kbd</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">     \n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"8e7af827-75d7-43d4-9b08-4bc107cc14fb\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"8e7af827-75d7-43d4-9b08-4bc107cc14fb\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">实验步骤</div></div></div><div data-block-id=\"1f8297c7-d998-4d0e-929f-4db84c29be5d\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"1f8297c7-d998-4d0e-929f-4db84c29be5d\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">信号量系统调用实现</div></div></div><div data-block-id=\"a719bca2-9a8c-47d4-a55f-64ffbf0401ee\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">kernel\\kernel.h中定义结构体类型<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">Semaphore</span>，并声明需要用到的相关全局变量，并且声明系统调用服务例程函数</div></div></div></div><div data-block-id=\"2ebbb933-c4a7-4e2a-a48a-3cba7f193c07\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token comment\" data-token-index=\"0\">// lab4</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">typedef</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">Semaphore</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> id</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t\t\t\t </span><span class=\"token comment\" data-token-index=\"0\">// semaphore identifier</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> val</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t\t\t </span><span class=\"token comment\" data-token-index=\"0\">// semaphore value</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">wait_queue</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> wq</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">   </span><span class=\"token comment\" data-token-index=\"0\">// wait queue</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">Semaphore</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// next semaphore</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> Sem_t</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token comment\" data-token-index=\"0\">// global variables</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">extern</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> GSID</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t\t</span><span class=\"token comment\" data-token-index=\"0\">// allocate global semaphore identifier</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">extern</span><span data-token-index=\"0\"> Sem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">   </span><span class=\"token comment\" data-token-index=\"0\">// header of semaphore link</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">extern</span><span data-token-index=\"0\"> Sem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> g_sem_slctd</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// selected semaphore in temporary use</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> value</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_destroy</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> semid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> semid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> semid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"4959649b-01e6-4c5b-9d78-2c0b7777264d\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">需要对<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">Semaphore</span>结构体类型说明的是：\n①<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"3\">Sem_t</span>为<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"5\">struct Semaphore</span>的别名\n②<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"7\">id</span>来自于<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"9\">GSID</span>的值，作用是标识唯一的信号量结构体，后面通过它来寻找对应的信号量结构体首地址\n③<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"11\">val</span>是信号量的值，在每一次P/V操作后会增1/减1\n④<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"13\">wq</span> 是存放要使用该信号量的线程的等待队列的头指针\n⑤<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"15\">next</span>使用next指针把所用信号量串成一个单向链表。</div></div></div></div><div data-block-id=\"ed42935a-eed6-4593-ae76-33330232ad60\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">在\\kernel\\sem.c中完成对全局变量的初始化，以及对系统调用服务例程函数的实现</div></div></div></div><div data-block-id=\"b3b7b6bd-deda-4457-b516-c47afa5e2441\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> GSID </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t\t\t</span><span class=\"token comment\" data-token-index=\"0\">// allocate global semaphore identifier</span><span data-token-index=\"0\">\nSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> g_sem_head </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">   </span><span class=\"token comment\" data-token-index=\"0\">// header of semaphore link</span><span data-token-index=\"0\">\nSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> g_sem_slctd </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// selected semaphore in temporary use</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// insert semaphore into link</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">InsertSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">Sem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> new</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">!</span><span data-token-index=\"0\">g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\t   </span><span class=\"token comment\" data-token-index=\"0\">// No semaphore</span><span data-token-index=\"0\">\n\t\tg_sem_head </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> new</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// to be header</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">else</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> p_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// locate to the tail semaphore</span><span data-token-index=\"0\">\n\t\t\tp_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tp_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> new</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// insert into this link</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// return the addr of semaphore by its id</span><span data-token-index=\"0\">\nSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">AddrSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> p_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">id </span><span class=\"token operator\" data-token-index=\"0\">==</span><span data-token-index=\"0\"> sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> p_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">else</span><span data-token-index=\"0\">\n\t\t\tp_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// create a new semaphore</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> value</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> new_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">Sem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token function\" data-token-index=\"0\">kmalloc</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">sizeof</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">Sem_t</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// if failed to alloc space</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">!</span><span data-token-index=\"0\">new_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// else</span><span data-token-index=\"0\">\n\tnew_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">id </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> GSID</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tnew_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> value</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tnew_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">wq </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tnew_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">InsertSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">new_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> GSID</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_destroy</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">!</span><span data-token-index=\"0\">g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> del </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">AddrSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// to be destroyed</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">del </span><span class=\"token operator\" data-token-index=\"0\">==</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">   </span><span class=\"token comment\" data-token-index=\"0\">// if the destroying semaphore is the link header</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">g_sem_head</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// and if exist others next to the header</span><span data-token-index=\"0\">\n\t\t\tg_sem_head </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// update header</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">kfree</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">del</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tdel </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">else</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\t\t\t\t\t\t</span><span class=\"token comment\" data-token-index=\"0\">// else, not the header</span><span data-token-index=\"0\">\n\t\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> p_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_sem_head</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// find the prev semaphore</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem </span><span class=\"token operator\" data-token-index=\"0\">&amp;&amp;</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next </span><span class=\"token operator\" data-token-index=\"0\">!=</span><span data-token-index=\"0\"> del</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> p_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> p_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// if p_Sem not NULL, p_Sem is prev semaphore, else, no prev one</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">p_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\tp_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> del</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">next</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">kfree</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">del</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\tdel </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> w_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">AddrSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">!</span><span data-token-index=\"0\">w_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// no this semaphore</span><span data-token-index=\"0\">\n    </span><span class=\"token keyword\" data-token-index=\"0\">if</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">sid</span><span class=\"token operator\" data-token-index=\"0\">==</span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n        </span><span class=\"token function\" data-token-index=\"0\">printk</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"w id val=%d\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tw_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val</span><span class=\"token operator\" data-token-index=\"0\">--</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\tuint32_t flags</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">save_flags_cli</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sleep_on</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">wq</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// let thread get into wait queue</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">restore_flags</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sys_sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\tSem_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> w_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">AddrSem</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">sid</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">!</span><span data-token-index=\"0\">w_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// no this semaphore</span><span data-token-index=\"0\">\n    </span><span class=\"token keyword\" data-token-index=\"0\">if</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">sid</span><span class=\"token operator\" data-token-index=\"0\">==</span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n        </span><span class=\"token function\" data-token-index=\"0\">printk</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"s id val=%d\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tw_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">val </span><span class=\"token operator\" data-token-index=\"0\">&lt;=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\tuint32_t flags</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">save_flags_cli</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">wake_up</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">w_Sem</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">wq</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// wake up a thread from wait queue</span><span data-token-index=\"0\">\n        </span><span class=\"token function\" data-token-index=\"0\">restore_flags</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">flags</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n    </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"2bd20416-bb3e-4f0e-8500-841b55e28821\" class=\"notion-selectable notion-quote-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"font-size: 1.2em; padding: 3px 2px; color: inherit; fill: inherit; display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Empty quote\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); border-left: 3px solid currentcolor; padding-left: 0.9em; padding-right: 0.9em;\">注：AddrSem(sid)可以得到id为sid的信号量x地址，但使用AddrSem(sid-1)来得到链表中信号量x的前一个信号量地址是有缺陷的，因为sid-1的信号量可能已被destroy。但本实验不涉及这个问题，你可以采用AddrSem(sid-1)先得到sid-1的信号量地址Y，然后Y-&gt;next自然便是信号量x的地址。</div></div></div><div data-block-id=\"d593d0fa-5cf1-4bd2-b498-6a542a34ae48\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">系统调用的添加，参考前几次实验的添加步骤，大致如下：</div></div></div></div><div data-block-id=\"5a7c1b3d-c87a-4d3f-b71c-0dae4e422e5a\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>1.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\userapp\\include\\syscall.h</span> 声明系统调用API</div></div></div></div></div><div data-block-id=\"ea74bfff-72fe-4322-aed3-a35825199b24\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>2.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\userapp\\lib\\syscall-wrapper.S</span> 定义封装例程</div></div></div></div></div><div data-block-id=\"34423782-928b-4100-b722-e6ab4d209bd7\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>3.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\include\\syscall-nr.h</span> 定义系统调用号</div></div></div></div></div><div data-block-id=\"d2f6735e-4fb7-439d-af71-5acf97d9035e\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>4.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\kernel\\kernel.h</span> 声明系统调用服务例程函数<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"2\">sys_xxx</span></div></div></div></div></div><div data-block-id=\"ffb62df9-13cc-4cab-8cb3-5dd620ff61d3\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>5.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\kernel\\sem.c</span> 实现系统调用服务例程函数</div></div></div></div></div><div data-block-id=\"ac1b1341-d3fd-4a67-bf64-02d9ea68e5cf\" class=\"notion-selectable notion-numbered_list-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"display: flex; align-items: flex-start; width: 100%; padding-left: 2px; color: inherit; fill: inherit;\"><div style=\"margin-right: 2px; width: 24px; display: flex; align-items: center; justify-content: center; flex-grow: 0; flex-shrink: 0; min-height: calc(1.5em + 3px + 3px);\"><span>6.</span></div><div style=\"flex: 1 1 0px; min-width: 1px; display: flex; flex-direction: column;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"List\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px; text-align: left;\"><span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"0\">\\kernel\\machdep.c</span> 在系统调用分发函数<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"2\">syscall()</span>中根据系统调用号加入<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"4\">SYSCALL_xxx</span>分支。\n跳过。</div></div></div></div></div><div data-block-id=\"c4ef21e6-fe48-47ea-bbff-be0644603627\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"c4ef21e6-fe48-47ea-bbff-be0644603627\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">生产者/消费者设计</div></div></div><div data-block-id=\"f0f96994-5e39-47aa-bed3-ca57d6fb8b0c\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">后面主要是创建线程，使用线程，画图之类的折腾，略述。\n\\userapp\\main.c中，声明全局变量，信号量ID，buffer大小</div></div></div></div><div data-block-id=\"e78e1052-81ff-4b84-a3a2-c259b8db71b5\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> ar_Size 25</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> bfN 8</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// empty,full,mutex semaphore</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// the buffer size, we have {bfN} buffers and each can</span><span data-token-index=\"0\">\n\t\t\t\t\t\t</span><span class=\"token comment\" data-token-index=\"0\">// contain {ar_Size} integers</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">main</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t……\n\temp_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tful_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t……\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"13a35413-beff-45e1-891d-3d5b56575232\" class=\"notion-selectable notion-quote-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"font-size: 1.2em; padding: 3px 2px; color: inherit; fill: inherit; display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Empty quote\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); border-left: 3px solid currentcolor; padding-left: 0.9em; padding-right: 0.9em;\">注：互斥信号量数量取决于buffer的数量，这样可使生产者在填充新的缓冲区同时，可以让消费者清除旧的缓冲区（针对多消费者多生产者情况）。若只一个，那么只有等生产者线程填充完新的缓冲区，消费者才能清除旧的缓冲区，尽管两者使用的缓冲区并不是同一个。即使生产者线程用完了自己的时间片，由于共用了同一互斥信号量，消费者线程得到时间片也进不了临界区，直到生产者线程完成新缓冲区的填充。</div></div></div><div data-block-id=\"8f628ea5-a1e3-456c-b5f9-e3827be0c58e\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">下面说说生产者与消费者线程函数的创建，模板如下（具体代码见尾部）:\n生产者线程函数模板：</div></div></div></div><div data-block-id=\"15d95592-0a07-475a-a0d7-239ed1ef7570\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tsk_foo_producer</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// 缓冲区编号</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// 填充缓冲区代码区</span><span data-token-index=\"0\">\n\t\t\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// 切换到下一个缓冲区</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"8a96d2b6-e728-4ecd-b3d2-f71a842197ca\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">消费者线程函数模板：</div></div></div></div><div data-block-id=\"a7d62cd1-d24e-407a-9e36-caa67979a5a0\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tsk_foo_consumer</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// 缓冲区编号</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// 清空缓冲区代码区</span><span data-token-index=\"0\">\n\t\t\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// 切换到下一个缓冲区</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"5dda3b39-ec0f-4cf4-b500-3446afca8485\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"5dda3b39-ec0f-4cf4-b500-3446afca8485\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">实验结果</div></div></div><div data-block-id=\"cc2432da-1a09-46b1-bad3-590b9127fabc\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://img.woyun.ink/article/2019/4/22/test_lab4.gif\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"f6a31ffd-c89c-41bd-8d91-cc830cab9829\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">可以直观地从图中看出，当缓冲区满了，生产者还想生产时，必须等待消费者消费一个缓冲区；缓冲区空时，消费者还想消费，必须等待生产者生产完一个。</div></div></div></div><div data-block-id=\"09bb552d-accb-459f-87b5-e9d9361e9173\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"09bb552d-accb-459f-87b5-e9d9361e9173\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">感谢</div></div></div><div data-block-id=\"95c2a45e-0d33-466a-b59d-79874bce6864\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">感谢洪明坚老师的ppt，感谢学长们的实验报告，感谢网上大神的笔记。</div></div></div></div><div data-block-id=\"32bfa939-c963-47b4-839f-02f2e73fa974\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"32bfa939-c963-47b4-839f-02f2e73fa974\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">代码附录</div></div></div><div data-block-id=\"77aeacd2-011c-434c-9da9-90c70502807d\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"77aeacd2-011c-434c-9da9-90c70502807d\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">main.c</div></div></div><div data-block-id=\"a24cf9d0-8e8b-47cd-a928-a2f9535e9427\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token comment\" data-token-index=\"0\">/*\n * vim: filetype=c:fenc=utf-8:ts=4:et:sw=4:sts=4\n */</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;inttypes.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;math.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;netinet/in.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;stddef.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;stdio.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;stdlib.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;sys/mman.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">&lt;syscall.h&gt;</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">\"graphics.h\"</span><span data-token-index=\"0\">\n\n</span><span class=\"token keyword\" data-token-index=\"0\">extern</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tlsf_create_with_pool</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> mem</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> size_t bytes</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">extern</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> g_heap</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// lab4</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">include</span><span class=\"token macro property\" data-token-index=\"0\"> </span><span class=\"token string\" data-token-index=\"0\">\"lab4.h\"</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">/**\n * GCC insists on __main\n *    &lt;http://gcc.gnu.org/onlinedocs/gccint/Collect2.html&gt;\n */</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">__main</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\tsize_t heap_size </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">32</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1024</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1024</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> heap_base </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">mmap</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> heap_size</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> PROT_READ </span><span class=\"token operator\" data-token-index=\"0\">|</span><span data-token-index=\"0\"> PROT_WRITE</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t\t\t\t   MAP_PRIVATE </span><span class=\"token operator\" data-token-index=\"0\">|</span><span data-token-index=\"0\"> MAP_ANON</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tg_heap </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tlsf_create_with_pool</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">heap_base</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> heap_size</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">/**\n * 第一个运行在用户模式的线程所执行的函数\n */</span><span data-token-index=\"0\">\n\n\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">main</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">printf</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"task #%d: I'm the first user task(pv=0x%08x)!\\\\r\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">task_getid</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t   pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token comment\" data-token-index=\"0\">// TODO: Your code goes here</span><span data-token-index=\"0\">\n    </span><span class=\"token function\" data-token-index=\"0\">test_lab4</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"29e9f967-adf1-4fec-ab03-dd44cfc6438a\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"29e9f967-adf1-4fec-ab03-dd44cfc6438a\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">lab4.h</div></div></div><div data-block-id=\"0b5ace0f-e892-4719-b7a9-63441e44a929\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 0px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">ifndef</span><span class=\"token macro property\" data-token-index=\"0\"> _LAB4_</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> _LAB4_</span><span data-token-index=\"0\">\n\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> ar_Size 25</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> max_Elem 100</span><span data-token-index=\"0\">\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> bfN 8</span><span data-token-index=\"0\">\n</span><span class=\"token comment\" data-token-index=\"0\">// global variables</span><span data-token-index=\"0\">\nuint16_t scr_X</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t </span><span class=\"token comment\" data-token-index=\"0\">// screen width</span><span data-token-index=\"0\">\nuint16_t scr_Y</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t\t </span><span class=\"token comment\" data-token-index=\"0\">// screen length</span><span data-token-index=\"0\">\nuint16_t buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">   </span><span class=\"token comment\" data-token-index=\"0\">// each buffer's width</span><span data-token-index=\"0\">\nuint16_t line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// each line's height</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">float</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\t </span><span class=\"token comment\" data-token-index=\"0\">// the ratio of transforming elements in array to a line's</span><span data-token-index=\"0\">\n\t\t\t\t\t </span><span class=\"token comment\" data-token-index=\"0\">// length</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// empty,full,mutex semaphore</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// the buffer size, we have {bfN} buffers and each can</span><span data-token-index=\"0\">\n\t\t\t\t\t\t</span><span class=\"token comment\" data-token-index=\"0\">// contain {ar_Size} integers</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// Drwa a line, width = 15</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> x0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> y0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> length</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> COLORREF cr</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">15</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">j </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> length</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setPixel</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">x0 </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> y0 </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> cr</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// Draw the bar to show priority</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">DrawPrioBar</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> length</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> LorR</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tCOLORREF cr</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">LorR </span><span class=\"token operator\" data-token-index=\"0\">==</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">8</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tcr </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">else</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">9</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tcr </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> x0 </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> seqN </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">10</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">20</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">++</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">j </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j </span><span class=\"token operator\" data-token-index=\"0\">&lt;=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">39</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">++</span><span data-token-index=\"0\">j</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">setPixel</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">x0 </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> cr</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">20</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">++</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">j </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j </span><span class=\"token operator\" data-token-index=\"0\">&lt;=</span><span data-token-index=\"0\"> length </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">++</span><span data-token-index=\"0\">j</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setPixel</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">x0 </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">119</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">136</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">153</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// set time delay for thread action</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">DrawDelay</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">long</span><span data-token-index=\"0\"> lMs</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">long</span><span data-token-index=\"0\"> lRemainingMilliSecond </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">lMs</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1000</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">long</span><span data-token-index=\"0\"> lNanoSecond </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> lRemainingMilliSecond </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1000000</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">struct</span><span data-token-index=\"0\"> </span><span class=\"token class-name\" data-token-index=\"0\">timespec</span><span data-token-index=\"0\"> ts_sleep</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> ts_remaining</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tts_sleep</span><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">tv_sec </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">lMs</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">/</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1000</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tts_sleep</span><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">tv_nsec </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> lNanoSecond</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">nanosleep</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span data-token-index=\"0\">ts_sleep</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span data-token-index=\"0\">ts_remaining</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// swap lines between a_lineNum and b_lineNum in the seqNum buffer</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">SwapBufLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> array</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> a_lineNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> a_lineNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> b_lineNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> b_lineNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> tmp </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> array</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tarray</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">a_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> array</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tarray</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">b_lineNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> tmp</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// Bubble Sort</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">BubbleSort</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> array</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// Draw again, unnecessary,just for beauty</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqNum </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t\t </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// start to sort this buffer</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">j </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> ar_Size </span><span class=\"token operator\" data-token-index=\"0\">-</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j </span><span class=\"token operator\" data-token-index=\"0\">&gt;</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> j</span><span class=\"token operator\" data-token-index=\"0\">--</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">if</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">array</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">j</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> array</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">j </span><span class=\"token operator\" data-token-index=\"0\">-</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">SwapBufLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">array</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> seqNum</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> j </span><span class=\"token operator\" data-token-index=\"0\">-</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawDelay</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">55</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// controller can change the priority</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tsk_foo_control</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> key</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> tid_List </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">pv</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> tid_A </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> tid_List</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> tid_B </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> tid_List</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// Draw priority bar first</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawPrioBar</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_A</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawPrioBar</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_B</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tkey </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">getchar</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// wait for input</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">switch</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">key</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">case</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0x4800</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// UP</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_A</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_A</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">break</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">case</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0x5000</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// DOWN</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_A</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_A</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">break</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">case</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0x4d00</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// RIGHT</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_B</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_B</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">-</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">break</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">case</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0x4b00</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// LEFT</span><span data-token-index=\"0\">\n\t\t\t\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_B</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">getpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_B</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">break</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token keyword\" data-token-index=\"0\">default</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// producer: generate rand arrays and put into buffer</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tsk_foo_producer</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// the sequence number of buffer</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">srand</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token function\" data-token-index=\"0\">time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// output the buffer</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t\tbuf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">rand</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> max_Elem</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_LenR</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">\n\t\t\t\t\t </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">255</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawDelay</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">40</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// next buffer</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// consumer: sort the array in buffer outside critical region</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">tsk_foo_consumer</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> seqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// the sequence number of buffer</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">while</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">BubbleSort</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">buf</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> seqN</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token comment\" data-token-index=\"0\">// clear the buffer</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawDelay</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">200</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n\t\t\t</span><span class=\"token function\" data-token-index=\"0\">DrawLine</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> line_Ylen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> buf_Xlen</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">RGB</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">seqN</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\t</span><span class=\"token function\" data-token-index=\"0\">sem_signal</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t\tseqN </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">seqN </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// next buffer</span><span data-token-index=\"0\">\n\t</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_exit</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token comment\" data-token-index=\"0\">// test function</span><span data-token-index=\"0\">\n</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">test_lab4</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// enter the gui</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> graphMode </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0x143</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">init_graphic</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">graphMode</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// initialize the semaphore</span><span data-token-index=\"0\">\n\temp_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">bfN</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tful_Sem </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> i</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// initial the parameter used to draw</span><span data-token-index=\"0\">\n\tscr_X </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_graphic_dev</span><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">XResolution</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tscr_Y </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> g_graphic_dev</span><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">YResolution</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tbuf_Xlen </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> scr_X </span><span class=\"token operator\" data-token-index=\"0\">/</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">bfN </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tline_Ylen </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> scr_Y </span><span class=\"token operator\" data-token-index=\"0\">/</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ar_Size</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tline_LenR </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">buf_Xlen </span><span class=\"token operator\" data-token-index=\"0\">/</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">float</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">max_Elem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token comment\" data-token-index=\"0\">// alloc stack space</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">unsigned</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> st_Size </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1024</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1024</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">unsigned</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">char</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">stk_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">stk_Con</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">stk_Ctr</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tstk_Pro </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">unsigned</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">char</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token function\" data-token-index=\"0\">malloc</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tstk_Con </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">unsigned</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">char</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token function\" data-token-index=\"0\">malloc</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\tstk_Ctr </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">unsigned</span><span data-token-index=\"0\"> </span><span class=\"token keyword\" data-token-index=\"0\">char</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token function\" data-token-index=\"0\">malloc</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// create threads</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> tid_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tid_Con</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tid_Ctr</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\ttid_Pro </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">task_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Pro </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tsk_foo_producer</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\ttid_Con </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">task_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Con </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tsk_foo_consumer</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> tid_List</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span class=\"token number\" data-token-index=\"0\">2</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">tid_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tid_Con</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\ttid_Ctr </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">task_create</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Ctr </span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\"> st_Size</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> tsk_foo_control</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">tid_List</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token comment\" data-token-index=\"0\">// initial the priorities</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">10</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Con</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">10</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">setpriority</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Ctr</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">1</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">// nice = -19</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token comment\" data-token-index=\"0\">// exit all threads</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Con</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">task_wait</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">tid_Ctr</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">free</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Pro</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">free</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Con</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">free</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">stk_Ctr</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\n\t</span><span class=\"token comment\" data-token-index=\"0\">// free the semaphore</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">sem_destroy</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">emp_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token function\" data-token-index=\"0\">sem_destroy</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ful_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n\t</span><span class=\"token keyword\" data-token-index=\"0\">for</span><span data-token-index=\"0\"> </span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">i </span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\"> </span><span class=\"token number\" data-token-index=\"0\">0</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i </span><span class=\"token operator\" data-token-index=\"0\">&lt;</span><span data-token-index=\"0\"> bfN</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> i</span><span class=\"token operator\" data-token-index=\"0\">++</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">sem_destroy</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">mut_Sem</span><span class=\"token punctuation\" data-token-index=\"0\">[</span><span data-token-index=\"0\">i</span><span class=\"token punctuation\" data-token-index=\"0\">]</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n\n</span><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">endif</span><span class=\"token macro property\" data-token-index=\"0\">  </span><span class=\"token comment\" data-token-index=\"0\">//_LAB4_</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div>","id":"b091a848-e248-575b-8060-caab44d3db94","name":"操作系统实验——线程同步","tags":["操作系统"],"categories":["计算机基础","操作系统"],"public_date":"2019-04-20","slug":"442b4fbc623d4e3aa638f3a7e0739eb0"}},{"node":{"description":null,"html":"fetch error","id":"c77dd8ed-2068-572c-806d-715b1d3e7357","name":"操作系统实验——线程创建与调度","tags":["操作系统"],"categories":["计算机基础","操作系统"],"public_date":"2019-04-18","slug":"2bcafec576ec4a79b892c9ec55dff1ac"}},{"node":{"description":null,"html":"<div data-block-id=\"cf59d04e-3f53-41be-8e27-5bcaf73df509\" class=\"notion-selectable notion-table_of_contents-block\" style=\"width: 100%; max-width: 608px; margin-top: 2px; margin-bottom: 4px;\"><div style=\"position: relative;\"><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#b5b8cf33-985b-4a37-9698-a5c9314db95b\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">系统调用的用户接口</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#b71c5ae7-9a0c-4387-8874-ffcab86c9797\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">C语言的接口声明</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#5e4facf9-529c-4f8f-897f-2b906dcb447f\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 24px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">汇编中例程封装</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#409b2154-d319-465f-a404-1ebf1a797c57\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">中断发生</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#8b9213d8-d542-4c90-9a32-69397c994ed4\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">中断处理</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#f642cd27-2d86-4a40-bda3-60a206bec20e\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">系统调用</div></div></div></a></div><div style=\"color: rgba(55, 53, 47, 0.6); fill: rgba(55, 53, 47, 0.6);\"><a href=\"#e5cfb494-928b-4696-83cd-7509bd7466a3\" rel=\"noopener noreferrer\" style=\"display: block; color: inherit; text-decoration: none;\"><div role=\"button\" tabindex=\"0\" style=\"user-select: none; transition: background 20ms ease-in 0s; cursor: pointer; width: 100%;\"><div style=\"padding: 6px 2px; font-size: 14px; line-height: 1.3; display: flex; align-items: center; margin-left: 0px;\"><div class=\"notranslate\" style=\"white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-image: linear-gradient(to right, rgba(55, 53, 47, 0.16) 0%, rgba(55, 53, 47, 0.16) 100%); background-repeat: repeat-x; background-position: 0px 100%; background-size: 100% 1px;\">中断返回</div></div></div></a></div></div></div><div data-block-id=\"046c1af7-23d1-4a09-ad7c-b242887e1c69\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\"><span style=\"font-weight:600\" data-token-index=\"0\">实验内容：</span></div></div></div></div><div data-block-id=\"bb856618-5e74-462f-a7a5-9ecd75e7124f\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553947983400.png?table=block&amp;id=bb856618-5e74-462f-a7a5-9ecd75e7124f&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"4d2ab90f-0caf-46af-b302-9d67410caba8\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">一脸懵逼地按照PPT搬完所有代码，不知道原理所在，后悔课上没认真听。下面就做做总结，其中错误希望后面能纠正。</div></div></div></div><div data-block-id=\"f218710d-76be-4671-ace5-1cea5b51082c\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">EPOS文件<a href=\"https://pan.idzc.me/Developing%20Tools/EPOS.rar\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"1\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\">下载</span></a><span style=\"font-weight:600\" data-token-index=\"2\">涉及到的文件：</span></div></div></div></div><div data-block-id=\"f1b11ca2-11dd-4595-b7db-6450f629192d\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\">epos:.\n|   Makefile\n|\n+---include\n|       syscall-nr.h\n|\n+---kernel\n|       kernel.h\n|       machdep.c\n|\n\\\\---userapp\n    |   main.c\n    |\n    +---include\n    |       syscall.h\n    |\n    \\\\---lib\n            syscall-wrapper.S</div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">Plain Text<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"57be157e-4ebd-4cab-9a2d-4868208b68b3\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">系统调用的过程大致如下：</div></div></div></div><div data-block-id=\"b946b18c-721e-4393-a6c7-bc976db1f45c\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553942968071.png?table=block&amp;id=b946b18c-721e-4393-a6c7-bc976db1f45c&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"b5b8cf33-985b-4a37-9698-a5c9314db95b\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"b5b8cf33-985b-4a37-9698-a5c9314db95b\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">系统调用的用户接口</div></div></div><div data-block-id=\"58658b85-fdcb-4933-86ee-2f75f04fb6e9\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">main.c中调用：</div></div></div></div><div data-block-id=\"bd3892f1-7190-4651-b608-c356e43ebe1c\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token function\" data-token-index=\"0\">main</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token keyword\" data-token-index=\"0\">void</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">pv</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n    ……\n    </span><span class=\"token comment\" data-token-index=\"0\">// System call test</span><span data-token-index=\"0\">\n    time_t now</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n    </span><span class=\"token function\" data-token-index=\"0\">printf</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"When arg is NULL, return value is:\\\\t%d\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span class=\"token function\" data-token-index=\"0\">time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n    </span><span class=\"token function\" data-token-index=\"0\">printf</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"When arg is time_t type pointer,\\\\nPointer value is:\\\\t%d\\\\nReturn value is:\\\\t%d\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\">now</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span class=\"token function\" data-token-index=\"0\">time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token operator\" data-token-index=\"0\">&amp;</span><span data-token-index=\"0\">now</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n    ……\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"b71c5ae7-9a0c-4387-8874-ffcab86c9797\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"b71c5ae7-9a0c-4387-8874-ffcab86c9797\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">C语言的接口声明</div></div></div><div data-block-id=\"ac2845d5-c5d0-4522-ab58-06a3f9602057\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">如果实现<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">time</span>，\\usrapp\\include\\syscall.h中声明：</div></div></div></div><div data-block-id=\"a1701d5f-d481-45a9-a3d3-5ef0d34e6ff8\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span data-token-index=\"0\">time_t </span><span class=\"token function\" data-token-index=\"0\">time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">time_t </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">loc</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"5e4facf9-529c-4f8f-897f-2b906dcb447f\" class=\"notion-selectable notion-sub_sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"5e4facf9-529c-4f8f-897f-2b906dcb447f\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.25em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 3\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">汇编中例程封装</div></div></div><div data-block-id=\"949a509d-8445-436b-a70e-e7f66fb512c2\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">\\userapp\\lib\\syscall-wrapper.S中完成了接口的的汇编语言实现，先将系统调用号放进<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">eax</span>，然后触发软中断<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"3\">0x82</span>，（epos通过中断进入内核态）：</div></div></div></div><div data-block-id=\"b81e5667-69e3-4730-90e4-2abc662a3884\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> WRAPPER(name) \\\\</span><span data-token-index=\"0\">\n  </span><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">globl _ ## name</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> \\\\\n_ ## name</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\"> \\\\\n    movl $SYSCALL_ ## name</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\">eax</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> \\\\\n    </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> $</span><span class=\"token number\" data-token-index=\"0\">0x82</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> \\\\\n    ret</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"a6ab6a4b-e0c5-4ddd-b560-8b2ad23b89e7\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">如果是实现<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">time</span>，那么实现如下：</div></div></div></div><div data-block-id=\"c3a4765b-3ee3-439a-9bbb-9423504236bb\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token punctuation\" data-token-index=\"0\">.</span><span data-token-index=\"0\">globl _time</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n_time</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\">\n    movl $SYSCALL_time</span><span class=\"token punctuation\" data-token-index=\"0\">,</span><span data-token-index=\"0\"> </span><span class=\"token operator\" data-token-index=\"0\">%</span><span data-token-index=\"0\">eax\n    </span><span class=\"token keyword\" data-token-index=\"0\">int</span><span data-token-index=\"0\"> $</span><span class=\"token number\" data-token-index=\"0\">0x82</span><span data-token-index=\"0\">\n    ret</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"cf64dec2-f02e-47fa-83ea-9864d27a520e\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">在\\include\\syscall-nr.h中，定义系统调用号：</div></div></div></div><div data-block-id=\"2915d21c-c5f4-41e8-91dd-442b4085b8d4\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token macro property\" data-token-index=\"0\">#</span><span class=\"token directive keyword\" data-token-index=\"0\">define</span><span class=\"token macro property\" data-token-index=\"0\"> SYSCALL_time        1636</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"409b2154-d319-465f-a404-1ebf1a797c57\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"409b2154-d319-465f-a404-1ebf1a797c57\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">中断发生</div></div></div><div data-block-id=\"292940a3-5003-46e0-8b98-cbcc11763915\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">触发<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">0x82</span>中断后，CPU从用户模式切换到内核模式，并完成栈的切换。</div></div></div></div><div data-block-id=\"6e67b6ac-cf0d-4af9-a2cc-80f1e2925724\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553930607702.png?table=block&amp;id=6e67b6ac-cf0d-4af9-a2cc-80f1e2925724&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"91c56b32-234f-40c9-ac6c-e0e4cb022d3e\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">保护中断现场，即压入到内核栈中：</div></div></div></div><div data-block-id=\"c1234027-ba24-442e-a06f-e26ad627419b\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553931746052.png?table=block&amp;id=c1234027-ba24-442e-a06f-e26ad627419b&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"8b9213d8-d542-4c90-9a32-69397c994ed4\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"8b9213d8-d542-4c90-9a32-69397c994ed4\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">中断处理</div></div></div><div data-block-id=\"2686552a-48f7-4b15-b9d9-147e773bc29f\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">CPU在内核模式下，根据中断号，将控制传给<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">hwintXX</span>(XX为中断号）。\n在<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"3\">\\kernel\\entry.S</span>中实现，</div></div></div></div><div data-block-id=\"b2924ebb-b373-45ae-aa1e-edd4ac335920\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553930473353.png?table=block&amp;id=b2924ebb-b373-45ae-aa1e-edd4ac335920&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"c072cd98-0c10-49db-9957-42cdbe2cb276\" class=\"notion-selectable notion-quote-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"font-size: 1.2em; padding: 3px 2px; color: inherit; fill: inherit; display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Empty quote\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); border-left: 3px solid currentcolor; padding-left: 0.9em; padding-right: 0.9em;\">注：pushal, popal - push/pop EAX,EBX,ECX,EDX,ESP,EBP,ESI,EDI</div></div></div><div data-block-id=\"11d951ab-4481-424f-a3dd-8cbc5c314a0e\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">本应是这样，但在epos中，0x82的中断处理被单独实现——</div></div></div></div><div data-block-id=\"017f8906-4ceb-44c5-8391-42ccc56a76fb\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span data-token-index=\"0\">_int0x82_syscall</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"8e237182-ec8f-49bd-b26a-45c4d84c8e60\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">（\\epos\\kernel\\entry.S中）：</div></div></div></div><div data-block-id=\"6fe3cb89-5d65-4137-b650-02dcd2c9de2c\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553935475018.png?table=block&amp;id=6fe3cb89-5d65-4137-b650-02dcd2c9de2c&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"f642cd27-2d86-4a40-bda3-60a206bec20e\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"f642cd27-2d86-4a40-bda3-60a206bec20e\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">系统调用</div></div></div><div data-block-id=\"b9a482f4-edd8-4c1a-a712-87fd6ff5a715\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">在<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">_int0x82_syscall</span>中，先将内核模式现场压入内核栈，然后调用C语言函数<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"3\">syscall()</span>（系统调用处理程序），并从传入的参数ctx读取系统调用编号<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"5\">ctx-&gt;eax</span>，通过系统调用编号找到相应的服务例程：</div></div></div></div><div data-block-id=\"6ae05f5f-57be-444f-9643-736dc620d99f\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">下面以<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">sys_putchar</span>服务例程为例：</div></div></div></div><div data-block-id=\"f5b37e32-172a-4a22-9fd1-e29a714fc2f2\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553945513311.png?table=block&amp;id=f5b37e32-172a-4a22-9fd1-e29a714fc2f2&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"255fe00a-5de8-4c69-88ca-db902503f7e7\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">如果实现<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">sys_time</span>的调用，则如下：</div></div></div></div><div data-block-id=\"25413020-fdd5-42e9-93d7-2936f99048fa\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span class=\"token keyword\" data-token-index=\"0\">case</span><span data-token-index=\"0\"> SYSCALL_time</span><span class=\"token operator\" data-token-index=\"0\">:</span><span data-token-index=\"0\">\n    </span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n        time_t </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">loc</span><span class=\"token operator\" data-token-index=\"0\">=</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">time_t</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token operator\" data-token-index=\"0\">*</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">ctx</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">esp</span><span class=\"token operator\" data-token-index=\"0\">+</span><span class=\"token number\" data-token-index=\"0\">4</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> \n        ctx</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">eax</span><span class=\"token operator\" data-token-index=\"0\">=</span><span class=\"token function\" data-token-index=\"0\">sys_time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\"> \n        </span><span class=\"token keyword\" data-token-index=\"0\">if</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span data-token-index=\"0\">loc</span><span class=\"token operator\" data-token-index=\"0\">!=</span><span class=\"token constant\" data-token-index=\"0\">NULL</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span data-token-index=\"0\">\n            </span><span class=\"token operator\" data-token-index=\"0\">*</span><span data-token-index=\"0\">loc</span><span class=\"token operator\" data-token-index=\"0\">=</span><span data-token-index=\"0\">ctx</span><span class=\"token operator\" data-token-index=\"0\">-&gt;</span><span data-token-index=\"0\">eax</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n        </span><span class=\"token keyword\" data-token-index=\"0\">else</span><span data-token-index=\"0\">\n            </span><span class=\"token function\" data-token-index=\"0\">printk</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"Parameter is null!\\\\n\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n    </span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span data-token-index=\"0\">\n    </span><span class=\"token keyword\" data-token-index=\"0\">break</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"2251df17-e7f3-49b5-8cb3-389441498079\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">并在\\kernel\\kernel.h中声明<span style=\"font-family:&quot;SFMono-Regular&quot;, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;line-height:normal;background:rgba(135,131,120,0.15);color:#EB5757;border-radius:3px;font-size:85%;padding:0.2em 0.4em\" data-token-index=\"1\">time_t sys_time();</span>，然后在\\kernel\\machdep.c中实现：</div></div></div></div><div data-block-id=\"8deb12e8-9a38-491d-b3ad-6fc1c62d96a4\" class=\"notion-selectable notion-code-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"display: flex;\"><div style=\"flex-grow: 1; border-radius: 3px; text-align: left; position: relative; background: rgb(247, 246, 243); min-width: 0px; width: 100%;\"><div class=\"line-numbers notion-code-block\" style=\"display: flex; overflow-x: auto;\"><div contenteditable=\"false\" spellcheck=\"false\" autocorrect=\"off\" autocapitalize=\"off\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"flex-grow: 1; flex-shrink: 1; text-align: left; font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 85%; tab-size: 2; padding: 30px 16px 30px 20px; min-height: 1em; color: rgb(55, 53, 47); white-space: pre;\"><span data-token-index=\"0\">time_t </span><span class=\"token function\" data-token-index=\"0\">sys_time</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">{</span><span data-token-index=\"0\">\n    </span><span class=\"token function\" data-token-index=\"0\">printk</span><span class=\"token punctuation\" data-token-index=\"0\">(</span><span class=\"token string\" data-token-index=\"0\">\"System Call was caused! Well done!\\\\n\"</span><span class=\"token punctuation\" data-token-index=\"0\">)</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n    </span><span class=\"token keyword\" data-token-index=\"0\">return</span><span data-token-index=\"0\"> g_startup_time</span><span class=\"token operator\" data-token-index=\"0\">+</span><span data-token-index=\"0\">g_timer_ticks</span><span class=\"token operator\" data-token-index=\"0\">/</span><span data-token-index=\"0\">HZ</span><span class=\"token punctuation\" data-token-index=\"0\">;</span><span data-token-index=\"0\">\n</span><span class=\"token punctuation\" data-token-index=\"0\">}</span><span>\n</span></div></div><div style=\"position: absolute; top: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"></div><div style=\"position: absolute; bottom: 0px; right: 0px; color: rgba(55, 53, 47, 0.6); display: flex; align-items: center; justify-content: flex-end; height: 30px;\"><div role=\"button\" aria-disabled=\"true\" tabindex=\"-1\" style=\"user-select: none; transition: background 20ms ease-in 0s; display: inline-flex; align-items: center; white-space: nowrap; height: 20px; border-radius: 3px; font-size: 12px; line-height: 1.2; padding-left: 5px; padding-right: 5px; color: rgba(55, 53, 47, 0.6); margin-right: 5px;\">C<svg viewBox=\"0 0 30 30\" class=\"chevronDown\" style=\"width: 10px; height: 100%; display: block; fill: rgba(55, 53, 47, 0.3); flex-shrink: 0; backface-visibility: hidden; margin-left: 4px;\"><polygon points=\"15,17.4 4.8,7 2,9.8 15,23 28,9.8 25.2,7 \"></polygon></svg></div></div></div></div></div><div data-block-id=\"8e45cc6e-678c-44b7-b50b-9aa82f4b6a89\" class=\"notion-selectable notion-quote-block\" style=\"width: 100%; max-width: 608px; margin-top: 4px; margin-bottom: 4px;\"><div style=\"font-size: 1.2em; padding: 3px 2px; color: inherit; fill: inherit; display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Empty quote\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); border-left: 3px solid currentcolor; padding-left: 0.9em; padding-right: 0.9em;\">注：服务例程代表用户进程，并不属于中断上下文，而是进程上下文。因此，系统调用运行过程中，能够访问用户进程的很多信息，能够被其它进程抢占，能够休眠。所以进入syscall()前允许中断，出来后又屏蔽中断。</div></div></div><div data-block-id=\"e5cfb494-928b-4696-83cd-7509bd7466a3\" class=\"notion-selectable notion-sub_header-block\" style=\"width: 100%; max-width: 608px; margin-top: 1.4em; margin-bottom: 1px; color: rgb(55, 53, 47);\" id=\"e5cfb494-928b-4696-83cd-7509bd7466a3\"><div style=\"display: flex; width: 100%; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, &quot;Apple Color Emoji&quot;, Arial, sans-serif, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-weight: 600; font-size: 1.5em; line-height: 1.3; color: inherit; fill: inherit;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\"Heading 2\" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">中断返回</div></div></div><div data-block-id=\"06940081-0fec-4ae3-860b-8255a929b459\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">当系统调用完毕后，把控制权交回到发起调用的用户进程前，内核会有一次调度，即恢复现场：</div></div></div></div><div data-block-id=\"41304362-d65e-44f6-80eb-1c368e73db30\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553930555794.png?table=block&amp;id=41304362-d65e-44f6-80eb-1c368e73db30&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"9f726796-3051-4db7-a6ab-47e5ac471b4f\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 1px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">最终运行结果：</div></div></div></div><div data-block-id=\"9bd5dc56-bcad-42df-9fcb-7943c6ee2ca2\" class=\"notion-selectable notion-image-block\" style=\"width: 100%; max-width: 800px; align-self: center; margin-top: 0.5em; margin-bottom: 0.5em;\"><div><div style=\"display: flex;\"><div class=\"notion-cursor-default\" style=\"position: relative; overflow: hidden; flex-grow: 1;\"><div style=\"position: relative;\"><div style=\"width: 100%; height: 100%;\"><img src=\"https://www.notion.so/image/https%3A%2F%2Fimg.woyun.ink%2Farticle%2F2019%2F3%2F30%2F1553948711832.png?table=block&amp;id=9bd5dc56-bcad-42df-9fcb-7943c6ee2ca2&amp;cache=v2\" style=\"display: block; object-fit: cover; border-radius: 1px; width: 100%; pointer-events: auto;\"></div></div></div></div></div></div><div data-block-id=\"a0d07912-53d5-453d-a63d-91214915c26c\" class=\"notion-selectable notion-text-block\" style=\"width: 100%; max-width: 608px; margin-top: 1px; margin-bottom: 0px;\"><div style=\"color: inherit; fill: inherit;\"><div style=\"display: flex;\"><div contenteditable=\"false\" spellcheck=\"true\" placeholder=\" \" data-root=\"true\" class=\"\" style=\"max-width: 100%; width: 100%; white-space: pre-wrap; word-break: break-word; caret-color: rgb(55, 53, 47); padding: 3px 2px;\">参考：\n<a href=\"http://www.docin.com/p-1423493788.html\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"1\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\">http://www.docin.com/p-1423493788.html</span></a><a href=\"https://www.cnblogs.com/yfceshi/p/6885322.html\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"2\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\">https://www.cnblogs.com/yfceshi/p/6885322.html</span></a><a href=\"https://wenku.baidu.com/view/dd6fbf9c360cba1aa811da6d.html\" style=\"cursor:pointer;color:inherit;word-wrap:break-word;text-decoration:inherit\" class=\"notion-link-token notion-enable-hover\" target=\"_blank\" rel=\"noopener noreferrer\" data-token-index=\"3\"><span style=\"border-bottom:0.05em solid;border-color:rgba(55,53,47,0.4);opacity:0.7\">https://wenku.baidu.com/view/dd6fbf9c360cba1aa811da6d.html</span></a></div></div></div></div>","id":"bb73fcc2-0ef1-5374-84c0-9d845d30b238","name":"操作系统实验——创建系统调用","tags":["操作系统"],"categories":["计算机基础","操作系统"],"public_date":"2019-03-26","slug":"5817471f63ef4d76bd879ec0245cf4af"}}],"totalCount":3}},"pageContext":{"tag":"操作系统"}},"staticQueryHashes":["51046549"]}
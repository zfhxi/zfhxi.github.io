<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="操作系统实验——创建系统调用">
    <meta property="og:type" content="blog">
  <title>操作系统实验——创建系统调用</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="🏡">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism-solarizedlight.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='https://unpkg.com/valine/dist/Valine.min.js'></script>
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>🏡</span> <span>Home</span></div>
    </a>
                                                                                                                                                                                                                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="links.html">
      <div class="Navbar__Btn"><span>🔗</span> <span>Links</span></div>
    </a>
                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>👦🏻</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
        <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    <div>
            <span class="Header__Title">操作系统实验——创建系统调用</span>

    </div>
        <div class="DateTagBar">
            <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Mar 26, 2019</span>
                  <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
        <a href="tag/操作系统.html">操作系统</a>
      </span>
          </div>
      </header>
  <article id="https://www.notion.so/bc5915f3712a47bc8e6780cfb055bdbe" class="PageRoot"><ul id="https://www.notion.so/9f3fe3b23d034772881066fb74b7d434" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/ecd281625ba147a985a7027ca206a673"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">系统调用的用户接口</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/af7c7e79fcd54e0e9d3970bd2642dd09"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">C语言的接口声明</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1aa04b2aa6934be4bce31e22032bf0be"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">汇编中例程封装</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f44c58e48e4b4d61bf7f977c65e2cd5d"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">中断发生</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/77e8a6204056452bab5391345cab67b7"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">中断处理</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/875283787faa4ca98294a791bc071182"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">系统调用</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6afeb871bfa148209b2e0c1ad2089c1a"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">中断返回</span></span></div></a></li></ul><div id="https://www.notion.so/edcf04ee833342968ad6da014e73aa5c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">实验内容：</strong></span></span></p></div><div id="https://www.notion.so/bfe6dc3a2bb440cdac0a5e00fdb46e6d" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/807e8efb70b54615a3fca3010ac78d12" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一脸懵逼地按照PPT搬完所有代码，不知道原理所在，后悔课上没认真听。下面就做做总结，其中错误希望后面能纠正。</span></span></p></div><div id="https://www.notion.so/e7d4cc4ddbb14bf9944130449aedd594" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">EPOS文件</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://pan.idzc.me/Developing%20Tools/EPOS.rar">下载</a></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">涉及到的文件：</strong></span></span></p></div><pre id="https://www.notion.so/95c803367a484f50b44388ce51168c04" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>epos:.
|   Makefile
|
+---include
|       syscall-nr.h
|
+---kernel
|       kernel.h
|       machdep.c
|
\\---userapp
    |   main.c
    |
    +---include
    |       syscall.h
    |
    \\---lib
            syscall-wrapper.S</span></span></span></code></pre><div id="https://www.notion.so/15dcdd69f1d0479d85300c07b64d1ef1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用的过程大致如下：</span></span></p></div><div id="https://www.notion.so/a2d49ff432b3462a83f14b1ac0169307" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/ecd281625ba147a985a7027ca206a673" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ecd281625ba147a985a7027ca206a673"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">系统调用的用户接口</span></span></h2><div id="https://www.notion.so/946197c8a3804e458fd9268c5ef835a7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">main.c中调用：</span></span></p></div><pre id="https://www.notion.so/c9acf2f76a6c4478ac001a8d28dec6c6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ……
    <span class="token comment">// System call test</span>
    time_t now<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"When arg is NULL, return value is:\\t%d\\n"</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"When arg is time_t type pointer,\\nPointer value is:\\t%d\\nReturn value is:\\t%d\\n"</span><span class="token punctuation">,</span>now<span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/af7c7e79fcd54e0e9d3970bd2642dd09" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/af7c7e79fcd54e0e9d3970bd2642dd09"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">C语言的接口声明</span></span></h3><div id="https://www.notion.so/6bef1ce6b98a43138f2e9d66a3c210c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果实现</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">time</code></span><span class="SemanticString">，\usrapp\include\syscall.h中声明：</span></span></p></div><pre id="https://www.notion.so/f57bf5da75f94a2fac44b4135bfa8cf4" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>time_t <span class="token function">time</span><span class="token punctuation">(</span>time_t <span class="token operator">*</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/1aa04b2aa6934be4bce31e22032bf0be" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1aa04b2aa6934be4bce31e22032bf0be"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">汇编中例程封装</span></span></h3><div id="https://www.notion.so/c9b944da1eb14080ac7e2890b8e15775" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">\userapp\lib\syscall-wrapper.S中完成了接口的的汇编语言实现，先将系统调用号放进</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">eax</code></span><span class="SemanticString">，然后触发软中断</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0x82</code></span><span class="SemanticString">，（epos通过中断进入内核态）：</span></span></p></div><pre id="https://www.notion.so/c6c3067e15a3471e92d627a57d970d7c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">WRAPPER</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> \\</span></span>
  <span class="token punctuation">.</span>globl _ ## name<span class="token punctuation">;</span> \\
_ ## name<span class="token operator">:</span> \\
    movl $SYSCALL_ ## name<span class="token punctuation">,</span> <span class="token operator">%</span>eax<span class="token punctuation">;</span> \\
    <span class="token keyword">int</span> $<span class="token number">0x82</span><span class="token punctuation">;</span> \\
    ret</span></span></span></code></pre><div id="https://www.notion.so/9c193bfd89e94d48934ac93d726b64ae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果是实现</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">time</code></span><span class="SemanticString">，那么实现如下：</span></span></p></div><pre id="https://www.notion.so/b7539c6b21b342e580bd4d139dc9c557" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">.</span>globl _time<span class="token punctuation">;</span>
_time<span class="token operator">:</span>
    movl $SYSCALL_time<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    <span class="token keyword">int</span> $<span class="token number">0x82</span>
    ret</span></span></span></code></pre><div id="https://www.notion.so/c6025d2cde0b4109bd3d9c4eb845957a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在\include\syscall-nr.h中，定义系统调用号：</span></span></p></div><pre id="https://www.notion.so/36a83411e2804e03bfc7cf6f2372a305" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">SYSCALL_time        <span class="token number">1636</span></span></span></span></span></span></code></pre><h2 id="https://www.notion.so/f44c58e48e4b4d61bf7f977c65e2cd5d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f44c58e48e4b4d61bf7f977c65e2cd5d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">中断发生</span></span></h2><div id="https://www.notion.so/220d525e84134a16974c0b91df95d1d1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">触发</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">0x82</code></span><span class="SemanticString">中断后，CPU从用户模式切换到内核模式，并完成栈的切换。</span></span></p></div><div id="https://www.notion.so/a17eb81f8aef45569116594834ea03b8" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/740adad828cd40a1970c6646fe5c4ff5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">保护中断现场，即压入到内核栈中：</span></span></p></div><div id="https://www.notion.so/e53b9bf8bd7a4695869b792e2619c4eb" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/77e8a6204056452bab5391345cab67b7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/77e8a6204056452bab5391345cab67b7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">中断处理</span></span></h2><div id="https://www.notion.so/6c45fd9dc473443fb20becf70c594aae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">CPU在内核模式下，根据中断号，将控制传给</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hwintXX</code></span><span class="SemanticString">(XX为中断号）。
在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\entry.S</code></span><span class="SemanticString">中实现，</span></span></p></div><div id="https://www.notion.so/60969edf4bcc4f07bc6d85515246141c" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><blockquote id="https://www.notion.so/6f1c88aab5d5480e97329a07f52de05b" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：pushal, popal - push/pop EAX,EBX,ECX,EDX,ESP,EBP,ESI,EDI</span></span></blockquote><div id="https://www.notion.so/075471e1b8574b539038687486e26cd9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本应是这样，但在epos中，0x82的中断处理被单独实现——</span></span></p></div><pre id="https://www.notion.so/0a3f7d3a8e494ce7bf1223c625d66aed" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>_int0x82_syscall</span></span></span></code></pre><div id="https://www.notion.so/e2311c9b35e34e3e86e0bfcde5f6a9f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（\epos\kernel\entry.S中）：</span></span></p></div><div id="https://www.notion.so/1985ffd1d8c24d9f931e2000e3e67b94" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/875283787faa4ca98294a791bc071182" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/875283787faa4ca98294a791bc071182"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">系统调用</span></span></h2><div id="https://www.notion.so/7e234214ee5b45ceacd174defba2e0af" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">_int0x82_syscall</code></span><span class="SemanticString">中，先将内核模式现场压入内核栈，然后调用C语言函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">syscall()</code></span><span class="SemanticString">（系统调用处理程序），并从传入的参数ctx读取系统调用编号</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ctx-&gt;eax</code></span><span class="SemanticString">，通过系统调用编号找到相应的服务例程：</span></span></p></div><div id="https://www.notion.so/035af8aac5f84b35bc113d88159bf73b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面以</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_putchar</code></span><span class="SemanticString">服务例程为例：</span></span></p></div><div id="https://www.notion.so/0fe1a360db044fee9c53f09561b7716a" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/804124fb40c849eb8778accdeaa14069" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果实现</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_time</code></span><span class="SemanticString">的调用，则如下：</span></span></p></div><pre id="https://www.notion.so/3104dc5ed8674de39e21a2762a2727c6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">case</span> SYSCALL_time<span class="token operator">:</span>
    <span class="token punctuation">{</span>
        time_t <span class="token operator">*</span>loc<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>time_t<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>esp<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        ctx<span class="token operator">-></span>eax<span class="token operator">=</span><span class="token function">sys_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>loc<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token operator">*</span>loc<span class="token operator">=</span>ctx<span class="token operator">-></span>eax<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Parameter is null!\\n\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/1908e18ab3f04ec3ba9da3aca918d355" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">并在\kernel\kernel.h中声明</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">time_t sys_time();</code></span><span class="SemanticString">，然后在\kernel\machdep.c中实现：</span></span></p></div><pre id="https://www.notion.so/e68ae9c35a814675be415c73cda873b5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>time_t <span class="token function">sys_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"System Call was caused! Well done!\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> g_startup_time<span class="token operator">+</span>g_timer_ticks<span class="token operator">/</span>HZ<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><blockquote id="https://www.notion.so/411813b9325248df8331979def798a50" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：服务例程代表用户进程，并不属于中断上下文，而是进程上下文。因此，系统调用运行过程中，能够访问用户进程的很多信息，能够被其它进程抢占，能够休眠。所以进入syscall()前允许中断，出来后又屏蔽中断。</span></span></blockquote><h2 id="https://www.notion.so/6afeb871bfa148209b2e0c1ad2089c1a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6afeb871bfa148209b2e0c1ad2089c1a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">中断返回</span></span></h2><div id="https://www.notion.so/786d9b77050e41a6b1159ff80a3bdb86" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当系统调用完毕后，把控制权交回到发起调用的用户进程前，内核会有一次调度，即恢复现场：</span></span></p></div><div id="https://www.notion.so/f5cfb08052634b4493d426c7fb7d9f83" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f6a5314dfc7b4cbe842ed15ff8e55ea3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最终运行结果：</span></span></p></div><div id="https://www.notion.so/393a2d51fbe5402a90cfc3e8335956b8" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/02ead85c75ac4622ad58eab8abfbb297" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考：
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://www.docin.com/p-1423493788.html">http://www.docin.com/p-1423493788.html</a></span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.cnblogs.com/yfceshi/p/6885322.html">https://www.cnblogs.com/yfceshi/p/6885322.html</a></span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://wenku.baidu.com/view/dd6fbf9c360cba1aa811da6d.html">https://wenku.baidu.com/view/dd6fbf9c360cba1aa811da6d.html</a></span></span></p></div></article>  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: 'x3yNlOp8snKVbHLuM3MDgyPm-gzGzoHsz',
      appKey: 'IxbPmtJ4C181kqwCPyUfHb67',
      avatar: 'retro',
      placeholder: 'Welcome to comment here233!',
      requiredFields: ['nick', 'mail']
    })
  </script>
  <footer class="Footer">
    <div>&copy; idzc.me 2020</div>
    <div>&centerdot;</div>
    <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
        rel="noopener noreferrer">Notablog</a>.
    </div>
  </footer>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="æ“ä½œç³»ç»Ÿå®éªŒâ€”â€”çº¿ç¨‹åŒæ­¥">
    <meta name="description" content="æœ€è¿‘åˆšåšäº†æœ€åä¸€æ¬¡å®éªŒï¼Œå®ç°å¤šçº¿ç¨‹åŒæ­¥ï¼ˆå¤šçº¿ç¨‹å¯¹åŒä¸€ä¸ªç¼“å†²åŒºçš„ä½¿ç”¨é—®é¢˜ï¼‰ï¼Œæ¶‰åŠåˆ°ä¿¡å·é‡çš„è®¾è®¡ï¼Œè¿™æ­£æ˜¯æˆ‘çŸ¥è¯†ç‚¹ç›²åŒºâ€¦â€¦">
  <meta property="og:description" content="æœ€è¿‘åˆšåšäº†æœ€åä¸€æ¬¡å®éªŒï¼Œå®ç°å¤šçº¿ç¨‹åŒæ­¥ï¼ˆå¤šçº¿ç¨‹å¯¹åŒä¸€ä¸ªç¼“å†²åŒºçš„ä½¿ç”¨é—®é¢˜ï¼‰ï¼Œæ¶‰åŠåˆ°ä¿¡å·é‡çš„è®¾è®¡ï¼Œè¿™æ­£æ˜¯æˆ‘çŸ¥è¯†ç‚¹ç›²åŒºâ€¦â€¦">
    <meta property="og:type" content="blog">
  <title>æ“ä½œç³»ç»Ÿå®éªŒâ€”â€”çº¿ç¨‹åŒæ­¥</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="ğŸ¡">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism-solarizedlight.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='https://unpkg.com/valine/dist/Valine.min.js'></script>
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>ğŸ¡</span> <span>Home</span></div>
    </a>
                                                                                                                                                                                                                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="links.html">
      <div class="Navbar__Btn"><span>ğŸ”—</span> <span>Links</span></div>
    </a>
                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ‘¦ğŸ»</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
        <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    <div>
            <span class="Header__Title">æ“ä½œç³»ç»Ÿå®éªŒâ€”â€”çº¿ç¨‹åŒæ­¥</span>

    </div>
        <div class="DateTagBar">
            <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Apr 20, 2019</span>
                  <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
        <a href="tag/æ“ä½œç³»ç»Ÿ.html">æ“ä½œç³»ç»Ÿ</a>
      </span>
          </div>
      </header>
  <article id="https://www.notion.so/03e71ac7a1bb4ce3af569cfaa9c946fb" class="PageRoot"><ul id="https://www.notion.so/801c1973bd2b4f8eafc98c9f984ca12e" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">å®éªŒå†…å®¹</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">å®ç°ä¿¡å·é‡</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1d946c7417724d95b7b896df5c4876a5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">è®¾è®¡ç”Ÿäº§è€…/æ¶ˆè´¹è€…</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2efa459e00b54ddc9a67742168129d95"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">é¢„å¤‡çŸ¥è¯†</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">ä¿¡å·é‡</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">çº¿ç¨‹ç¡çœ /å”¤é†’API</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">å®éªŒæ­¥éª¤</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">ä¿¡å·é‡ç³»ç»Ÿè°ƒç”¨å®ç°</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4a23709180234b5594c6e402eebffb35"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿäº§è€…/æ¶ˆè´¹è€…è®¾è®¡</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ea61ad09e50a4ba287f37107692e8619"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">å®éªŒç»“æœ</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">æ„Ÿè°¢</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">ä»£ç é™„å½•</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7223cf98e52b469587163be3c67dd7ce"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">main.c</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">lab4.h</span></span></div></a></li></ul><div id="https://www.notion.so/39dfac38b9cb49aeac3bda5af918a3f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æœ€è¿‘åˆšåšäº†æœ€åä¸€æ¬¡å®éªŒï¼Œå®ç°å¤šçº¿ç¨‹åŒæ­¥ï¼ˆå¤šçº¿ç¨‹å¯¹åŒä¸€ä¸ªç¼“å†²åŒºçš„ä½¿ç”¨é—®é¢˜ï¼‰ï¼Œæ¶‰åŠåˆ°ä¿¡å·é‡çš„è®¾è®¡ï¼Œè¿™æ­£æ˜¯æˆ‘çŸ¥è¯†ç‚¹ç›²åŒºï¼Œæ‰€ä»¥å†™å¾—æœ‰ç‚¹ä¹…äº†ã€‚</span></span></p></div><div id="https://www.notion.so/d621678c17214832b1564ffd83f4c6ef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">äºæ˜¯å‚è€ƒæ­¤å¤„ï¼Œç•¥è¡¥äº†ä¸€ç‚¹çŸ¥è¯†ï¼š</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore">https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore</a></span></span></p></div><div id="https://www.notion.so/553762ae23fc48f5a42886076db9b093" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸‹é¢è¿›å…¥æ­£é¢˜ï¼ˆå¼€å§‹æŠ„è€å¸ˆpptï¼‰ã€‚</span></span></p></div><h2 id="https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å®éªŒå†…å®¹</span></span></h2><h3 id="https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å®ç°ä¿¡å·é‡</span></span></h3><div id="https://www.notion.so/5b52cc84e4374e01aa04dd349efe51a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç¼–è¾‘æ–‡ä»¶kernel/sem.cï¼Œå®ç°å¦‚ä¸‹å››ä¸ªå‡½æ•°
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_create(int value)value</code></span><span class="SemanticString">æ˜¯ä¿¡å·é‡çš„åˆå€¼
åˆ†é…å†…å­˜è¦ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">kmalloc</code></span><span class="SemanticString">ï¼Œä¸èƒ½ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">malloc</code></span><span class="SemanticString">ï¼
æˆåŠŸè¿”å›ä¿¡å·é‡IDï¼Œå¦åˆ™è¿”å›-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_destroy(int semid)</code></span><span class="SemanticString">
é‡Šæ”¾å†…å­˜è¦ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">kfree</code></span><span class="SemanticString">ï¼Œä¸èƒ½ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">free</code></span><span class="SemanticString">ï¼
æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_wait(int semid)</code></span><span class="SemanticString">
Pæ“ä½œï¼Œè¦ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">å’Œå‡½æ•°</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sleep_on</code></span><span class="SemanticString">
æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_signal(int semid)</code></span><span class="SemanticString">
Væ“ä½œï¼Œè¦ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">å’Œå‡½æ•°</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wake_up</code></span><span class="SemanticString">
æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›-1
æŠŠè¿™å››ä¸ªå‡½æ•°åšæˆç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«æ˜¯</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sem_create/destroy/wait/signal</code></span></span></p></div><h3 id="https://www.notion.so/1d946c7417724d95b7b896df5c4876a5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1d946c7417724d95b7b896df5c4876a5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">è®¾è®¡ç”Ÿäº§è€…/æ¶ˆè´¹è€…</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/c6c353d88de444b281c3d422d721a2cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">â‘ åœ¨å›¾å½¢æ¨¡å¼ä¸‹å°†å±å¹•æ²¿å‚ç›´æ–¹å‘åˆ†æˆNä»½ï¼Œä½œä¸ºNä¸ªç¼“å†²åŒºã€‚å…¶æ¬¡ï¼Œåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ç”Ÿäº§è€…ï¼Œè´Ÿè´£ç”Ÿæˆéšæœºæ•°å¹¶å¡«åˆ°ç¼“å†²åŒºä¸­ï¼›å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯æ¶ˆè´¹è€…ï¼Œè´Ÿè´£æŠŠç¼“å†²åŒºä¸­çš„éšæœºæ•°è¿›è¡Œæ’åº</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/c86f15154fe94365a682b157a8273bd9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿäº§è€…ç”Ÿæˆéšæœºæ•°åï¼Œè¦ç”»åˆ°ç¼“å†²åŒº</span></span></li><li id="https://www.notion.so/c9cefe5fb93d4f1ab42361f104a3d4c7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">æ¶ˆè´¹è€…å®Œæˆæ’åºä¹‹åï¼Œè¦æ¸…é™¤ç¼“å†²åŒº</span></span></li></ul></li><li id="https://www.notion.so/429b5b52bf174cefb054b5f5e2519ecf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">â‘¡åˆ›å»ºä¸€ä¸ªæ§åˆ¶çº¿ç¨‹ï¼Œç”¨é”®up/downæ§åˆ¶ç”Ÿäº§è€…çš„ä¼˜å…ˆçº§ï¼Œç”¨é”®right/leftæ§åˆ¶æ¶ˆè´¹è€…çš„ä¼˜å…ˆçº§</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/f2afcb6dfcc44ac7a1ba8923ecd22631" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">æŠŠæ§åˆ¶çº¿ç¨‹çš„é™æ€ä¼˜å…ˆçº§è®¾ç½®åˆ°æœ€é«˜ï¼Œä»¥ä¿è¯æ§åˆ¶æ•ˆæœ</span></span></li><li id="https://www.notion.so/f9ebd0fce8bf45b9a8bbe97201f7f689" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">åœ¨å±å¹•ä¸Šç”¨è¿›åº¦æ¡åŠ¨æ€æ˜¾ç¤ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é™æ€ä¼˜å…ˆçº§</span></span></li></ul></li></ul><h2 id="https://www.notion.so/2efa459e00b54ddc9a67742168129d95" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2efa459e00b54ddc9a67742168129d95"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">é¢„å¤‡çŸ¥è¯†</span></span></h2><h3 id="https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ä¿¡å·é‡</span></span></h3><div id="https://www.notion.so/3e7fa7a637b146949d53311633bd3fcd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å…³äºä¿¡å·é‡</strong></span><span class="SemanticString">
å¯ä»¥å‚è€ƒæ–‡ç« :</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/Wangzhike/HIT-Linux-0.11/blob/master/5-semaphore/%20Linux%200.11%E4%B8%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E5%BA%94%E7%94%A8.md"> Linux 0.11ä¸‹ä¿¡å·é‡çš„å®ç°å’Œåº”ç”¨</a></span></span></p></div><div id="https://www.notion.so/55ceb26814424860a5e2fa145fda4d75" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">EPOSäº’æ–¥</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2f18b112a0f243ceb3b09c44853a082b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">EPOSè¿è¡Œäºå•CPUçš„è®¡ç®—æœºä¸Š â€“å†…æ ¸å¯ä»¥ç”¨å¼€å…³ä¸­æ–­å®ç°äº’æ–¥</span></span></li><li id="https://www.notion.so/94f137c6d9a6425bae3a1d2841fc3261" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ä¸­æ–­çš„å¼€å…³ç”±EFLAGSä¸­çš„IFä½å†³å®šï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/07c83fd90e2249d69fbbb8e6235b2572" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">stiï¼ŒIF=1 ä¸­æ–­æ‰“å¼€</span></span></li><li id="https://www.notion.so/8416f6042d0f45cd9e6c37515b113835" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cliï¼ŒIF=0 ä¸­æ–­å…³é—­</span></span></li></ul></li></ul><div id="https://www.notion.so/b2dc38ef278f44eea181e3bbb622ff2e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">EFLAGSç»„æˆå¦‚ä¸‹ï¼š</span></span></p></div><div id="https://www.notion.so/415a06ecb1054562bf1a1dd5bcf4aaee" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f464320d4f9f4a28b1762a8ec57aa8bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">EPOSæä¾›çš„ä¸­æ–­APIï¼š</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/0ab8dced976f40059225ca3c344e3303" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ä¿å­˜EFLAGSçš„å€¼åˆ°ä¸€ä¸ªå˜é‡flagsä¸­ï¼Œç„¶åIF=0
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli(flags)</code></span></span></li><li id="https://www.notion.so/0b401a6874d140f995bb26f29f835668" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">æŠŠå˜é‡flagsçš„å€¼æ¢å¤åˆ°EFLAGSä¸­
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags(flags)</code></span></span></li></ul><div id="https://www.notion.so/7da9b2cf167d46c9bf7d586191d28018" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sample:</span></span></p></div><pre id="https://www.notion.so/29ad863656664fe1961e937608a43ad5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>uint32_t flags<span class="token punctuation">;</span>
<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

ä¸´ç•ŒåŒº

<span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span></span></span></span></code></pre><h3 id="https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">çº¿ç¨‹ç¡çœ /å”¤é†’API</span></span></h3><div id="https://www.notion.so/d5ac129d80f04d38a855337f61e58d14" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ç¡çœ </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">void sleep_on(struct wait_queue **head)</code></span><span class="SemanticString">
å‚æ•°headæ˜¯ç¡çœ é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆ
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å”¤é†’</strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">void wake_up(struct wait_queue **head, int n)</code></span><span class="SemanticString">
å‚æ•°nè¡¨ç¤ºè¦å”¤é†’çš„çº¿ç¨‹ä¸ªæ•°ï¼Œnå°äº0è¡¨ç¤ºå”¤é†’è¯¥é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çº¿ç¨‹
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sleep_on</code></span><span class="SemanticString">å’Œ</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wake_up</code></span><span class="SemanticString">å¿…é¡»åœ¨å…³ä¸­æ–­ç¯å¢ƒä¸­è¿è¡Œï¼Œå³ç”¨</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">ä¿æŠ¤</span></span></p></div><div id="https://www.notion.so/895a532552f4436f8bb79c4109fcd6f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sample:</span></span></p></div><pre id="https://www.notion.so/e944678d24334c0ba88a1e3c445c7a67" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">wait_queue</span> <span class="token operator">*</span>wq_kbd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//!!!éå¸¸é‡è¦!!!</span>
uint16_t   buf_kbd<span class="token punctuation">;</span>
<span class="token comment">//ä»é”®ç›˜è¯»æŒ‰é”®ä¿¡æ¯</span>
<span class="token keyword">int</span> <span class="token function">sys_getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     uint32_t flags<span class="token punctuation">;</span>
     <span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token comment">//ç¡çœ ç­‰å¾…ç”¨æˆ·æŒ‰é”®</span>
     <span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_kbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> buf_kbd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//é”®ç›˜ä¸­æ–­å¤„ç†å‡½æ•°</span>
<span class="token keyword">void</span> <span class="token function">isr_keyboard</span><span class="token punctuation">(</span>uint32_t irq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">context</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     buf_kbd <span class="token operator">=</span> <span class="token function">read_data_from_kbd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
     <span class="token comment">//æ³¨æ„ï¼šåœ¨ISRä¸­ï¼Œä¸­æ–­å·²ç»è¢«å…³é—­</span>
     <span class="token comment">//å”¤é†’1ä¸ªç­‰å¾…ç”¨æˆ·æŒ‰é”®çš„çº¿ç¨‹</span>
     <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_kbd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å®éªŒæ­¥éª¤</span></span></h2><h3 id="https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ä¿¡å·é‡ç³»ç»Ÿè°ƒç”¨å®ç°</span></span></h3><div id="https://www.notion.so/178fdb73e0394f4fa01539f6cae189f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">kernel\kernel.hä¸­å®šä¹‰ç»“æ„ä½“ç±»å‹</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Semaphore</code></span><span class="SemanticString">ï¼Œå¹¶å£°æ˜éœ€è¦ç”¨åˆ°çš„ç›¸å…³å…¨å±€å˜é‡ï¼Œå¹¶ä¸”å£°æ˜ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹å‡½æ•°</span></span></p></div><pre id="https://www.notion.so/dad2ed8118d242b6ab5d7bab72467403" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// lab4</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Semaphore</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> id<span class="token punctuation">;</span>					 <span class="token comment">// semaphore identifier</span>
	<span class="token keyword">int</span> val<span class="token punctuation">;</span>				 <span class="token comment">// semaphore value</span>
	<span class="token keyword">struct</span> <span class="token class-name">wait_queue</span><span class="token operator">*</span> wq<span class="token punctuation">;</span>   <span class="token comment">// wait queue</span>
	<span class="token keyword">struct</span> <span class="token class-name">Semaphore</span><span class="token operator">*</span> next<span class="token punctuation">;</span>  <span class="token comment">// next semaphore</span>
<span class="token punctuation">}</span> Sem_t<span class="token punctuation">;</span>
<span class="token comment">// global variables</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> GSID<span class="token punctuation">;</span>			<span class="token comment">// allocate global semaphore identifier</span>
<span class="token keyword">extern</span> Sem_t<span class="token operator">*</span> g_sem_head<span class="token punctuation">;</span>   <span class="token comment">// header of semaphore link</span>
<span class="token keyword">extern</span> Sem_t<span class="token operator">*</span> g_sem_slctd<span class="token punctuation">;</span>  <span class="token comment">// selected semaphore in temporary use</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_destroy</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/8274cd49d7754723b701943c3ef21ace" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">éœ€è¦å¯¹</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Semaphore</code></span><span class="SemanticString">ç»“æ„ä½“ç±»å‹è¯´æ˜çš„æ˜¯ï¼š
â‘ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Sem_t</code></span><span class="SemanticString">ä¸º</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">struct Semaphore</code></span><span class="SemanticString">çš„åˆ«å
â‘¡</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">id</code></span><span class="SemanticString">æ¥è‡ªäº</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">GSID</code></span><span class="SemanticString">çš„å€¼ï¼Œä½œç”¨æ˜¯æ ‡è¯†å”¯ä¸€çš„ä¿¡å·é‡ç»“æ„ä½“ï¼Œåé¢é€šè¿‡å®ƒæ¥å¯»æ‰¾å¯¹åº”çš„ä¿¡å·é‡ç»“æ„ä½“é¦–åœ°å€
â‘¢</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">val</code></span><span class="SemanticString">æ˜¯ä¿¡å·é‡çš„å€¼ï¼Œåœ¨æ¯ä¸€æ¬¡P/Væ“ä½œåä¼šå¢1/å‡1
â‘£</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wq</code></span><span class="SemanticString"> æ˜¯å­˜æ”¾è¦ä½¿ç”¨è¯¥ä¿¡å·é‡çš„çº¿ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆ
â‘¤</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">next</code></span><span class="SemanticString">ä½¿ç”¨nextæŒ‡é’ˆæŠŠæ‰€ç”¨ä¿¡å·é‡ä¸²æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚</span></span></p></div><div id="https://www.notion.so/2556fd77bcd2421e8a50d4047bc6c75b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨\kernel\sem.cä¸­å®Œæˆå¯¹å…¨å±€å˜é‡çš„åˆå§‹åŒ–ï¼Œä»¥åŠå¯¹ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹å‡½æ•°çš„å®ç°</span></span></p></div><pre id="https://www.notion.so/91ba5b3573734f328ba6a754cb70fad5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>
<span class="token keyword">int</span> GSID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">// allocate global semaphore identifier</span>
Sem_t<span class="token operator">*</span> g_sem_head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">// header of semaphore link</span>
Sem_t<span class="token operator">*</span> g_sem_slctd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// selected semaphore in temporary use</span>

<span class="token comment">// insert semaphore into link</span>
<span class="token keyword">void</span> <span class="token function">InsertSem</span><span class="token punctuation">(</span>Sem_t<span class="token operator">*</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_sem_head<span class="token punctuation">)</span>	   <span class="token comment">// No semaphore</span>
		g_sem_head <span class="token operator">=</span> new<span class="token punctuation">;</span>  <span class="token comment">// to be header</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>next<span class="token punctuation">)</span>  <span class="token comment">// locate to the tail semaphore</span>
			p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
		p_Sem<span class="token operator">-></span>next <span class="token operator">=</span> new<span class="token punctuation">;</span>  <span class="token comment">// insert into this link</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// return the addr of semaphore by its id</span>
Sem_t<span class="token operator">*</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>id <span class="token operator">==</span> sid<span class="token punctuation">)</span>
			<span class="token keyword">return</span> p_Sem<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// create a new semaphore</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> new_Sem <span class="token operator">=</span> <span class="token punctuation">(</span>Sem_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Sem_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// if failed to alloc space</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">// else</span>
	new_Sem<span class="token operator">-></span>id <span class="token operator">=</span> GSID<span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>wq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">InsertSem</span><span class="token punctuation">(</span>new_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> GSID<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_destroy</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_sem_head<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	Sem_t<span class="token operator">*</span> del <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// to be destroyed</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>del <span class="token operator">==</span> g_sem_head<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// if the destroying semaphore is the link header</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>g_sem_head<span class="token operator">-></span>next<span class="token punctuation">)</span>  <span class="token comment">// and if exist others next to the header</span>
			g_sem_head <span class="token operator">=</span> g_sem_head<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token comment">// update header</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
		del <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>						<span class="token comment">// else, not the header</span>
		Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>  <span class="token comment">// find the prev semaphore</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>next <span class="token operator">!=</span> del<span class="token punctuation">)</span><span class="token punctuation">)</span> p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token comment">// if p_Sem not NULL, p_Sem is prev semaphore, else, no prev one</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Sem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			p_Sem<span class="token operator">-></span>next <span class="token operator">=</span> del<span class="token operator">-></span>next<span class="token punctuation">;</span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
			del <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> w_Sem <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// no this semaphore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sid<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"w id val=%d\\n"</span><span class="token punctuation">,</span>w_Sem<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	w_Sem<span class="token operator">-></span>val<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>val <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		uint32_t flags<span class="token punctuation">;</span>
		<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// let thread get into wait queue</span>
		<span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> w_Sem <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// no this semaphore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sid<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s id val=%d\\n"</span><span class="token punctuation">,</span>w_Sem<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	w_Sem<span class="token operator">-></span>val<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>val <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		uint32_t flags<span class="token punctuation">;</span>
		<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wake up a thread from wait queue</span>
        <span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><blockquote id="https://www.notion.so/c806686f527c4e38bd86978521cc657a" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">æ³¨ï¼šAddrSem(sid)å¯ä»¥å¾—åˆ°idä¸ºsidçš„ä¿¡å·é‡xåœ°å€ï¼Œä½†ä½¿ç”¨AddrSem(sid-1)æ¥å¾—åˆ°é“¾è¡¨ä¸­ä¿¡å·é‡xçš„å‰ä¸€ä¸ªä¿¡å·é‡åœ°å€æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå› ä¸ºsid-1çš„ä¿¡å·é‡å¯èƒ½å·²è¢«destroyã€‚ä½†æœ¬å®éªŒä¸æ¶‰åŠè¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥é‡‡ç”¨AddrSem(sid-1)å…ˆå¾—åˆ°sid-1çš„ä¿¡å·é‡åœ°å€Yï¼Œç„¶åY-&gt;nextè‡ªç„¶ä¾¿æ˜¯ä¿¡å·é‡xçš„åœ°å€ã€‚</span></span></blockquote><div id="https://www.notion.so/76579668e4e84f29873e3a1e353aab9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç³»ç»Ÿè°ƒç”¨çš„æ·»åŠ ï¼Œå‚è€ƒå‰å‡ æ¬¡å®éªŒçš„æ·»åŠ æ­¥éª¤ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/4f2852f53fe34569ac125e08bd16c03d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\include\syscall.h</code></span><span class="SemanticString"> å£°æ˜ç³»ç»Ÿè°ƒç”¨API</span></span></li><li id="https://www.notion.so/671746028bc94f669237403d0ee89f22" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\lib\syscall-wrapper.S</code></span><span class="SemanticString"> å®šä¹‰å°è£…ä¾‹ç¨‹</span></span></li><li id="https://www.notion.so/b029ae87cbbd4c33baf3d516882256e4" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\include\syscall-nr.h</code></span><span class="SemanticString"> å®šä¹‰ç³»ç»Ÿè°ƒç”¨å·</span></span></li><li id="https://www.notion.so/0c661f67d9474c6bbc6f42a05ae8e076" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\kernel.h</code></span><span class="SemanticString"> å£°æ˜ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹å‡½æ•°</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_xxx</code></span></span></li><li id="https://www.notion.so/2645bf4349e24389ad06697588d62278" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\sem.c</code></span><span class="SemanticString"> å®ç°ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹å‡½æ•°</span></span></li><li id="https://www.notion.so/dfac390e104b41f7ad9b4ca21184c816" class="NumberedList" value="6"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\machdep.c</code></span><span class="SemanticString"> åœ¨ç³»ç»Ÿè°ƒç”¨åˆ†å‘å‡½æ•°</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">syscall()</code></span><span class="SemanticString">ä¸­æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·åŠ å…¥</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SYSCALL_xxx</code></span><span class="SemanticString">åˆ†æ”¯ã€‚
è·³è¿‡ã€‚</span></span></li></ol><h3 id="https://www.notion.so/4a23709180234b5594c6e402eebffb35" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4a23709180234b5594c6e402eebffb35"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿäº§è€…/æ¶ˆè´¹è€…è®¾è®¡</span></span></h3><div id="https://www.notion.so/589b2560cfef4c57848cd6b17a22b319" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åé¢ä¸»è¦æ˜¯åˆ›å»ºçº¿ç¨‹ï¼Œä½¿ç”¨çº¿ç¨‹ï¼Œç”»å›¾ä¹‹ç±»çš„æŠ˜è…¾ï¼Œç•¥è¿°ã€‚
\userapp\main.cä¸­ï¼Œå£°æ˜å…¨å±€å˜é‡ï¼Œä¿¡å·é‡IDï¼Œbufferå¤§å°</span></span></p></div><pre id="https://www.notion.so/7d9f260c79af4f8dbcdc1d5862bb7145" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">ar_Size <span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">bfN <span class="token number">8</span></span></span>
<span class="token keyword">int</span> emp_Sem<span class="token punctuation">,</span> ful_Sem<span class="token punctuation">,</span> mut_Sem<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// empty,full,mutex semaphore</span>
<span class="token keyword">int</span> buf<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// the buffer size, we have {bfN} buffers and each can</span>
						<span class="token comment">// contain {ar_Size} integers</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span><span class="token punctuation">{</span>
	â€¦â€¦
	emp_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span>bfN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ful_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	â€¦â€¦
<span class="token punctuation">}</span></span></span></span></code></pre><blockquote id="https://www.notion.so/38b2e9bd24664b8f99021c801a8add97" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">æ³¨ï¼šäº’æ–¥ä¿¡å·é‡æ•°é‡å–å†³äºbufferçš„æ•°é‡ï¼Œè¿™æ ·å¯ä½¿ç”Ÿäº§è€…åœ¨å¡«å……æ–°çš„ç¼“å†²åŒºåŒæ—¶ï¼Œå¯ä»¥è®©æ¶ˆè´¹è€…æ¸…é™¤æ—§çš„ç¼“å†²åŒºï¼ˆé’ˆå¯¹å¤šæ¶ˆè´¹è€…å¤šç”Ÿäº§è€…æƒ…å†µï¼‰ã€‚è‹¥åªä¸€ä¸ªï¼Œé‚£ä¹ˆåªæœ‰ç­‰ç”Ÿäº§è€…çº¿ç¨‹å¡«å……å®Œæ–°çš„ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¸…é™¤æ—§çš„ç¼“å†²åŒºï¼Œå°½ç®¡ä¸¤è€…ä½¿ç”¨çš„ç¼“å†²åŒºå¹¶ä¸æ˜¯åŒä¸€ä¸ªã€‚å³ä½¿ç”Ÿäº§è€…çº¿ç¨‹ç”¨å®Œäº†è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œç”±äºå…±ç”¨äº†åŒä¸€äº’æ–¥ä¿¡å·é‡ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å¾—åˆ°æ—¶é—´ç‰‡ä¹Ÿè¿›ä¸äº†ä¸´ç•ŒåŒºï¼Œç›´åˆ°ç”Ÿäº§è€…çº¿ç¨‹å®Œæˆæ–°ç¼“å†²åŒºçš„å¡«å……ã€‚</span></span></blockquote><div id="https://www.notion.so/536bdeb95c484af3906cc9ed63a41b79" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä¸‹é¢è¯´è¯´ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°çš„åˆ›å»ºï¼Œæ¨¡æ¿å¦‚ä¸‹ï¼ˆå…·ä½“ä»£ç è§å°¾éƒ¨ï¼‰:
ç”Ÿäº§è€…çº¿ç¨‹å‡½æ•°æ¨¡æ¿ï¼š</span></span></p></div><pre id="https://www.notion.so/3a364d1e9235470fa9895c1161b51a3b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">tsk_foo_producer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// ç¼“å†²åŒºç¼–å·</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// å¡«å……ç¼“å†²åŒºä»£ç åŒº</span>
		
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç¼“å†²åŒº</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/236677a8b4f843f69c45569bfb6b13f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°æ¨¡æ¿ï¼š</span></span></p></div><pre id="https://www.notion.so/69d31899b74249efb0aecd1ae7a83912" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">tsk_foo_consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// ç¼“å†²åŒºç¼–å·</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// æ¸…ç©ºç¼“å†²åŒºä»£ç åŒº</span>
		
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç¼“å†²åŒº</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/ea61ad09e50a4ba287f37107692e8619" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ea61ad09e50a4ba287f37107692e8619"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å®éªŒç»“æœ</span></span></h2><div id="https://www.notion.so/93b4edb7ec3d47aa88a0cf7d9c730344" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/34b8619ce82049a58bbbef6846df2a89" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å¯ä»¥ç›´è§‚åœ°ä»å›¾ä¸­çœ‹å‡ºï¼Œå½“ç¼“å†²åŒºæ»¡äº†ï¼Œç”Ÿäº§è€…è¿˜æƒ³ç”Ÿäº§æ—¶ï¼Œå¿…é¡»ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€ä¸ªç¼“å†²åŒºï¼›ç¼“å†²åŒºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…è¿˜æƒ³æ¶ˆè´¹ï¼Œå¿…é¡»ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§å®Œä¸€ä¸ªã€‚</span></span></p></div><h2 id="https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">æ„Ÿè°¢</span></span></h2><div id="https://www.notion.so/bd5fe903e5b54cab88b0093fc3bb4b66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ„Ÿè°¢æ´ªæ˜åšè€å¸ˆçš„pptï¼Œæ„Ÿè°¢å­¦é•¿ä»¬çš„å®éªŒæŠ¥å‘Šï¼Œæ„Ÿè°¢ç½‘ä¸Šå¤§ç¥çš„ç¬”è®°ã€‚</span></span></p></div><h2 id="https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ä»£ç é™„å½•</span></span></h2><h3 id="https://www.notion.so/7223cf98e52b469587163be3c67dd7ce" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7223cf98e52b469587163be3c67dd7ce"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">main.c</span></span></h3><pre id="https://www.notion.so/6974a7bfb51e4fa4b4132fdef4a9aa5d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">/*
 * vim: filetype=c:fenc=utf-8:ts=4:et:sw=4:sts=4
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;inttypes.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stddef.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;syscall.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"graphics.h"</span></span>

<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">tlsf_create_with_pool</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> mem<span class="token punctuation">,</span> size_t bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> g_heap<span class="token punctuation">;</span>

<span class="token comment">// lab4</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lab4.h"</span></span>

<span class="token comment">/**
 * GCC insists on __main
 *    &lt;http://gcc.gnu.org/onlinedocs/gccint/Collect2.html>
 */</span>
<span class="token keyword">void</span> <span class="token function">__main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	size_t heap_size <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token operator">*</span> heap_base <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> heap_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>
						   MAP_PRIVATE <span class="token operator">|</span> MAP_ANON<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	g_heap <span class="token operator">=</span> <span class="token function">tlsf_create_with_pool</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">,</span> heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * ç¬¬ä¸€ä¸ªè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼çš„çº¿ç¨‹æ‰€æ‰§è¡Œçš„å‡½æ•°
 */</span>


<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"task #%d: I'm the first user task(pv=0x%08x)!\\r\\n"</span><span class="token punctuation">,</span> <span class="token function">task_getid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		   pv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// TODO: Your code goes here</span>
    <span class="token function">test_lab4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">;</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">lab4.h</span></span></h3><pre id="https://www.notion.so/050be2a9f9ac408cb5b607b8ebb377e1" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_LAB4_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">_LAB4_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">ar_Size <span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">max_Elem <span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">bfN <span class="token number">8</span></span></span>
<span class="token comment">// global variables</span>
uint16_t scr_X<span class="token punctuation">;</span>		 <span class="token comment">// screen width</span>
uint16_t scr_Y<span class="token punctuation">;</span>		 <span class="token comment">// screen length</span>
uint16_t buf_Xlen<span class="token punctuation">;</span>   <span class="token comment">// each buffer's width</span>
uint16_t line_Ylen<span class="token punctuation">;</span>  <span class="token comment">// each line's height</span>
<span class="token keyword">float</span> line_LenR<span class="token punctuation">;</span>	 <span class="token comment">// the ratio of transforming elements in array to a line's</span>
					 <span class="token comment">// length</span>
<span class="token keyword">int</span> emp_Sem<span class="token punctuation">,</span> ful_Sem<span class="token punctuation">,</span> mut_Sem<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// empty,full,mutex semaphore</span>
<span class="token keyword">int</span> buf<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// the buffer size, we have {bfN} buffers and each can</span>
						<span class="token comment">// contain {ar_Size} integers</span>

<span class="token comment">// Drwa a line, width = 15</span>
<span class="token keyword">void</span> <span class="token function">DrawLine</span><span class="token punctuation">(</span><span class="token keyword">int</span> x0<span class="token punctuation">,</span> <span class="token keyword">int</span> y0<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> COLORREF cr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> j<span class="token punctuation">,</span> y0 <span class="token operator">+</span> i<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Draw the bar to show priority</span>
<span class="token keyword">void</span> <span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> LorR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN<span class="token punctuation">;</span>
	COLORREF cr<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>LorR <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		seqN <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		seqN <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> x0 <span class="token operator">=</span> seqN <span class="token operator">*</span> buf_Xlen <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">39</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
			<span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// set time delay for thread action</span>
<span class="token keyword">void</span> <span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token keyword">long</span> lMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">long</span> lRemainingMilliSecond <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> lNanoSecond <span class="token operator">=</span> lRemainingMilliSecond <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timespec</span> ts_sleep<span class="token punctuation">,</span> ts_remaining<span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> lNanoSecond<span class="token punctuation">;</span>
	<span class="token function">nanosleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_sleep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts_remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// swap lines between a_lineNum and b_lineNum in the seqNum buffer</span>
<span class="token keyword">void</span> <span class="token function">SwapBufLine</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> seqNum<span class="token punctuation">,</span> <span class="token keyword">int</span> a_lineNum<span class="token punctuation">,</span> <span class="token keyword">int</span> b_lineNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
			 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
			 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tmp <span class="token operator">=</span> array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Bubble Sort</span>
<span class="token keyword">void</span> <span class="token function">BubbleSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> seqNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token comment">// Draw again, unnecessary,just for beauty</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
				 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// start to sort this buffer</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> ar_Size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">SwapBufLine</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> seqNum<span class="token punctuation">,</span> j<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// controller can change the priority</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_control</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> key<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> tid_List <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>pv<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_A <span class="token operator">=</span> tid_List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_B <span class="token operator">=</span> tid_List<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Draw priority bar first</span>
		<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		key <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wait for input</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x4800</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// UP</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x5000</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// DOWN</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4d00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// RIGHT</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4b00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// LEFT</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// producer: generate rand arrays and put into buffer</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_producer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// the sequence number of buffer</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// output the buffer</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> max_Elem<span class="token punctuation">;</span>
			<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqN <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
					 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// next buffer</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// consumer: sort the array in buffer outside critical region</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// the sequence number of buffer</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BubbleSort</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">,</span> seqN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// clear the buffer</span>
		<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> i<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqN <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf_Xlen<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// next buffer</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// test function</span>
<span class="token keyword">void</span> <span class="token function">test_lab4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// enter the gui</span>
	<span class="token keyword">int</span> graphMode <span class="token operator">=</span> <span class="token number">0x143</span><span class="token punctuation">;</span>
	<span class="token function">init_graphic</span><span class="token punctuation">(</span>graphMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initialize the semaphore</span>
	emp_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span>bfN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ful_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initial the parameter used to draw</span>
	scr_X <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>XResolution<span class="token punctuation">;</span>
	scr_Y <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>YResolution<span class="token punctuation">;</span>
	buf_Xlen <span class="token operator">=</span> scr_X <span class="token operator">/</span> <span class="token punctuation">(</span>bfN <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	line_Ylen <span class="token operator">=</span> scr_Y <span class="token operator">/</span> <span class="token punctuation">(</span>ar_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	line_LenR <span class="token operator">=</span> <span class="token punctuation">(</span>buf_Xlen <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>max_Elem<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// alloc stack space</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> st_Size <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>stk_Pro<span class="token punctuation">,</span> <span class="token operator">*</span>stk_Con<span class="token punctuation">,</span> <span class="token operator">*</span>stk_Ctr<span class="token punctuation">;</span>
	stk_Pro <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	stk_Con <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	stk_Ctr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// create threads</span>
	<span class="token keyword">int</span> tid_Pro<span class="token punctuation">,</span> tid_Con<span class="token punctuation">,</span> tid_Ctr<span class="token punctuation">;</span>
	tid_Pro <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Pro <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_producer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tid_Con <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Con <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_consumer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_List<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>tid_Pro<span class="token punctuation">,</span> tid_Con<span class="token punctuation">}</span><span class="token punctuation">;</span>
	tid_Ctr <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Ctr <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_control<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tid_List<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initial the priorities</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Pro<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Con<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nice = -19</span>

	<span class="token comment">// exit all threads</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Pro<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Con<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Pro<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Con<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Ctr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// free the semaphore</span>
	<span class="token function">sem_destroy</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_destroy</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">sem_destroy</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">//_LAB4_</span></span></span></span></span></code></pre></article>  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: 'x3yNlOp8snKVbHLuM3MDgyPm-gzGzoHsz',
      appKey: 'IxbPmtJ4C181kqwCPyUfHb67',
      avatar: 'retro',
      placeholder: 'Welcome to comment here233!',
      requiredFields: ['nick', 'mail']
    })
  </script>
  <footer class="Footer">
    <div>&copy; idzc.me 2020</div>
    <div>&centerdot;</div>
    <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
        rel="noopener noreferrer">Notablog</a>.
    </div>
  </footer>
</body>

</html>
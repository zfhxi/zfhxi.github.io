<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="操作系统实验——线程同步">
    <meta name="description" content="最近刚做了最后一次实验，实现多线程同步（多线程对同一个缓冲区的使用问题），涉及到信号量的设计，这正是我知识点盲区……">
  <meta property="og:description" content="最近刚做了最后一次实验，实现多线程同步（多线程对同一个缓冲区的使用问题），涉及到信号量的设计，这正是我知识点盲区……">
    <meta property="og:type" content="blog">
  <title>操作系统实验——线程同步</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="🏡">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism-solarizedlight.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='https://unpkg.com/valine/dist/Valine.min.js'></script>
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>🏡</span> <span>Home</span></div>
    </a>
                                                                                                                                                                                                                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="links.html">
      <div class="Navbar__Btn"><span>🔗</span> <span>Links</span></div>
    </a>
                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>👦🏻</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
        <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    <div>
            <span class="Header__Title">操作系统实验——线程同步</span>

    </div>
        <div class="DateTagBar">
            <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Apr 20, 2019</span>
                  <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
        <a href="tag/操作系统.html">操作系统</a>
      </span>
          </div>
      </header>
  <article id="https://www.notion.so/03e71ac7a1bb4ce3af569cfaa9c946fb" class="PageRoot"><ul id="https://www.notion.so/801c1973bd2b4f8eafc98c9f984ca12e" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验内容</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">实现信号量</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1d946c7417724d95b7b896df5c4876a5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">设计生产者/消费者</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2efa459e00b54ddc9a67742168129d95"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">预备知识</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">信号量</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">线程睡眠/唤醒API</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验步骤</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">信号量系统调用实现</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4a23709180234b5594c6e402eebffb35"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">生产者/消费者设计</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ea61ad09e50a4ba287f37107692e8619"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">实验结果</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">感谢</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">代码附录</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7223cf98e52b469587163be3c67dd7ce"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">main.c</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">lab4.h</span></span></div></a></li></ul><div id="https://www.notion.so/39dfac38b9cb49aeac3bda5af918a3f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">最近刚做了最后一次实验，实现多线程同步（多线程对同一个缓冲区的使用问题），涉及到信号量的设计，这正是我知识点盲区，所以写得有点久了。</span></span></p></div><div id="https://www.notion.so/d621678c17214832b1564ffd83f4c6ef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">于是参考此处，略补了一点知识：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore">https://github.com/Wangzhike/HIT-Linux-0.11/tree/master/5-semaphore</a></span></span></p></div><div id="https://www.notion.so/553762ae23fc48f5a42886076db9b093" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面进入正题（开始抄老师ppt）。</span></span></p></div><h2 id="https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d42b8d9dfe20484e86b577ae991ff45a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验内容</span></span></h2><h3 id="https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ee567f24d38b47e59fa4c0a68098b833"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实现信号量</span></span></h3><div id="https://www.notion.so/5b52cc84e4374e01aa04dd349efe51a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">编辑文件kernel/sem.c，实现如下四个函数
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_create(int value)value</code></span><span class="SemanticString">是信号量的初值
分配内存要用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">kmalloc</code></span><span class="SemanticString">，不能用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">malloc</code></span><span class="SemanticString">！
成功返回信号量ID，否则返回-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_destroy(int semid)</code></span><span class="SemanticString">
释放内存要用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">kfree</code></span><span class="SemanticString">，不能用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">free</code></span><span class="SemanticString">！
成功返回0，否则返回-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_wait(int semid)</code></span><span class="SemanticString">
P操作，要用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">和函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sleep_on</code></span><span class="SemanticString">
成功返回0，否则返回-1
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">int sys_sem_signal(int semid)</code></span><span class="SemanticString">
V操作，要用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">和函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wake_up</code></span><span class="SemanticString">
成功返回0，否则返回-1
把这四个函数做成系统调用，分别是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sem_create/destroy/wait/signal</code></span></span></p></div><h3 id="https://www.notion.so/1d946c7417724d95b7b896df5c4876a5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1d946c7417724d95b7b896df5c4876a5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">设计生产者/消费者</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/c6c353d88de444b281c3d422d721a2cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">①在图形模式下将屏幕沿垂直方向分成N份，作为N个缓冲区。其次，创建两个线程，其中一个是生产者，负责生成随机数并填到缓冲区中；另一个线程是消费者，负责把缓冲区中的随机数进行排序</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/c86f15154fe94365a682b157a8273bd9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">生产者生成随机数后，要画到缓冲区</span></span></li><li id="https://www.notion.so/c9cefe5fb93d4f1ab42361f104a3d4c7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">消费者完成排序之后，要清除缓冲区</span></span></li></ul></li><li id="https://www.notion.so/429b5b52bf174cefb054b5f5e2519ecf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">②创建一个控制线程，用键up/down控制生产者的优先级，用键right/left控制消费者的优先级</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/f2afcb6dfcc44ac7a1ba8923ecd22631" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">把控制线程的静态优先级设置到最高，以保证控制效果</span></span></li><li id="https://www.notion.so/f9ebd0fce8bf45b9a8bbe97201f7f689" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在屏幕上用进度条动态显示生产者和消费者的静态优先级</span></span></li></ul></li></ul><h2 id="https://www.notion.so/2efa459e00b54ddc9a67742168129d95" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2efa459e00b54ddc9a67742168129d95"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">预备知识</span></span></h2><h3 id="https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f747686ed92c4f09b2bd203f04c12f9e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">信号量</span></span></h3><div id="https://www.notion.so/3e7fa7a637b146949d53311633bd3fcd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">关于信号量</strong></span><span class="SemanticString">
可以参考文章:</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/Wangzhike/HIT-Linux-0.11/blob/master/5-semaphore/%20Linux%200.11%E4%B8%8B%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E5%BA%94%E7%94%A8.md"> Linux 0.11下信号量的实现和应用</a></span></span></p></div><div id="https://www.notion.so/55ceb26814424860a5e2fa145fda4d75" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">EPOS互斥</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/2f18b112a0f243ceb3b09c44853a082b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">EPOS运行于单CPU的计算机上 –内核可以用开关中断实现互斥</span></span></li><li id="https://www.notion.so/94f137c6d9a6425bae3a1d2841fc3261" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">中断的开关由EFLAGS中的IF位决定，指令如下：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/07c83fd90e2249d69fbbb8e6235b2572" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">sti，IF=1 中断打开</span></span></li><li id="https://www.notion.so/8416f6042d0f45cd9e6c37515b113835" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cli，IF=0 中断关闭</span></span></li></ul></li></ul><div id="https://www.notion.so/b2dc38ef278f44eea181e3bbb622ff2e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">EFLAGS组成如下：</span></span></p></div><div id="https://www.notion.so/415a06ecb1054562bf1a1dd5bcf4aaee" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f464320d4f9f4a28b1762a8ec57aa8bd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">EPOS提供的中断API：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/0ab8dced976f40059225ca3c344e3303" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">保存EFLAGS的值到一个变量flags中，然后IF=0
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli(flags)</code></span></span></li><li id="https://www.notion.so/0b401a6874d140f995bb26f29f835668" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">把变量flags的值恢复到EFLAGS中
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags(flags)</code></span></span></li></ul><div id="https://www.notion.so/7da9b2cf167d46c9bf7d586191d28018" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sample:</span></span></p></div><pre id="https://www.notion.so/29ad863656664fe1961e937608a43ad5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>uint32_t flags<span class="token punctuation">;</span>
<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

临界区

<span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span></span></span></span></code></pre><h3 id="https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d4fb385cbb5b4d2689891d1cb67fb50b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">线程睡眠/唤醒API</span></span></h3><div id="https://www.notion.so/d5ac129d80f04d38a855337f61e58d14" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">睡眠</strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">void sleep_on(struct wait_queue **head)</code></span><span class="SemanticString">
参数head是睡眠队列的头指针
</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">唤醒</strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">void wake_up(struct wait_queue **head, int n)</code></span><span class="SemanticString">
参数n表示要唤醒的线程个数，n小于0表示唤醒该队列中的所有线程
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sleep_on</code></span><span class="SemanticString">和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wake_up</code></span><span class="SemanticString">必须在关中断环境中运行，即用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">save_flags_cli</code></span><span class="SemanticString">/</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">restore_flags</code></span><span class="SemanticString">保护</span></span></p></div><div id="https://www.notion.so/895a532552f4436f8bb79c4109fcd6f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Sample:</span></span></p></div><pre id="https://www.notion.so/e944678d24334c0ba88a1e3c445c7a67" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">struct</span> <span class="token class-name">wait_queue</span> <span class="token operator">*</span>wq_kbd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//!!!非常重要!!!</span>
uint16_t   buf_kbd<span class="token punctuation">;</span>
<span class="token comment">//从键盘读按键信息</span>
<span class="token keyword">int</span> <span class="token function">sys_getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     uint32_t flags<span class="token punctuation">;</span>
     <span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token comment">//睡眠等待用户按键</span>
     <span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_kbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> buf_kbd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//键盘中断处理函数</span>
<span class="token keyword">void</span> <span class="token function">isr_keyboard</span><span class="token punctuation">(</span>uint32_t irq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">context</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     buf_kbd <span class="token operator">=</span> <span class="token function">read_data_from_kbd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
     <span class="token comment">//注意：在ISR中，中断已经被关闭</span>
     <span class="token comment">//唤醒1个等待用户按键的线程</span>
     <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_kbd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/daf0ecfe41ea49b9ba911602e933328b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验步骤</span></span></h2><h3 id="https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2e9acffc702b4cdba295dc0779e7b4eb"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">信号量系统调用实现</span></span></h3><div id="https://www.notion.so/178fdb73e0394f4fa01539f6cae189f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">kernel\kernel.h中定义结构体类型</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Semaphore</code></span><span class="SemanticString">，并声明需要用到的相关全局变量，并且声明系统调用服务例程函数</span></span></p></div><pre id="https://www.notion.so/dad2ed8118d242b6ab5d7bab72467403" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// lab4</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Semaphore</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> id<span class="token punctuation">;</span>					 <span class="token comment">// semaphore identifier</span>
	<span class="token keyword">int</span> val<span class="token punctuation">;</span>				 <span class="token comment">// semaphore value</span>
	<span class="token keyword">struct</span> <span class="token class-name">wait_queue</span><span class="token operator">*</span> wq<span class="token punctuation">;</span>   <span class="token comment">// wait queue</span>
	<span class="token keyword">struct</span> <span class="token class-name">Semaphore</span><span class="token operator">*</span> next<span class="token punctuation">;</span>  <span class="token comment">// next semaphore</span>
<span class="token punctuation">}</span> Sem_t<span class="token punctuation">;</span>
<span class="token comment">// global variables</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> GSID<span class="token punctuation">;</span>			<span class="token comment">// allocate global semaphore identifier</span>
<span class="token keyword">extern</span> Sem_t<span class="token operator">*</span> g_sem_head<span class="token punctuation">;</span>   <span class="token comment">// header of semaphore link</span>
<span class="token keyword">extern</span> Sem_t<span class="token operator">*</span> g_sem_slctd<span class="token punctuation">;</span>  <span class="token comment">// selected semaphore in temporary use</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_destroy</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/8274cd49d7754723b701943c3ef21ace" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">需要对</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Semaphore</code></span><span class="SemanticString">结构体类型说明的是：
①</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Sem_t</code></span><span class="SemanticString">为</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">struct Semaphore</code></span><span class="SemanticString">的别名
②</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">id</code></span><span class="SemanticString">来自于</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">GSID</code></span><span class="SemanticString">的值，作用是标识唯一的信号量结构体，后面通过它来寻找对应的信号量结构体首地址
③</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">val</code></span><span class="SemanticString">是信号量的值，在每一次P/V操作后会增1/减1
④</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wq</code></span><span class="SemanticString"> 是存放要使用该信号量的线程的等待队列的头指针
⑤</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">next</code></span><span class="SemanticString">使用next指针把所用信号量串成一个单向链表。</span></span></p></div><div id="https://www.notion.so/2556fd77bcd2421e8a50d4047bc6c75b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在\kernel\sem.c中完成对全局变量的初始化，以及对系统调用服务例程函数的实现</span></span></p></div><pre id="https://www.notion.so/91ba5b3573734f328ba6a754cb70fad5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>
<span class="token keyword">int</span> GSID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">// allocate global semaphore identifier</span>
Sem_t<span class="token operator">*</span> g_sem_head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">// header of semaphore link</span>
Sem_t<span class="token operator">*</span> g_sem_slctd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// selected semaphore in temporary use</span>

<span class="token comment">// insert semaphore into link</span>
<span class="token keyword">void</span> <span class="token function">InsertSem</span><span class="token punctuation">(</span>Sem_t<span class="token operator">*</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_sem_head<span class="token punctuation">)</span>	   <span class="token comment">// No semaphore</span>
		g_sem_head <span class="token operator">=</span> new<span class="token punctuation">;</span>  <span class="token comment">// to be header</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>next<span class="token punctuation">)</span>  <span class="token comment">// locate to the tail semaphore</span>
			p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
		p_Sem<span class="token operator">-></span>next <span class="token operator">=</span> new<span class="token punctuation">;</span>  <span class="token comment">// insert into this link</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// return the addr of semaphore by its id</span>
Sem_t<span class="token operator">*</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>id <span class="token operator">==</span> sid<span class="token punctuation">)</span>
			<span class="token keyword">return</span> p_Sem<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// create a new semaphore</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> new_Sem <span class="token operator">=</span> <span class="token punctuation">(</span>Sem_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Sem_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// if failed to alloc space</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">// else</span>
	new_Sem<span class="token operator">-></span>id <span class="token operator">=</span> GSID<span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>wq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	new_Sem<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">InsertSem</span><span class="token punctuation">(</span>new_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> GSID<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_destroy</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_sem_head<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	Sem_t<span class="token operator">*</span> del <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// to be destroyed</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>del <span class="token operator">==</span> g_sem_head<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// if the destroying semaphore is the link header</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>g_sem_head<span class="token operator">-></span>next<span class="token punctuation">)</span>  <span class="token comment">// and if exist others next to the header</span>
			g_sem_head <span class="token operator">=</span> g_sem_head<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token comment">// update header</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
		del <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>						<span class="token comment">// else, not the header</span>
		Sem_t<span class="token operator">*</span> p_Sem <span class="token operator">=</span> g_sem_head<span class="token punctuation">;</span>  <span class="token comment">// find the prev semaphore</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>p_Sem <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p_Sem<span class="token operator">-></span>next <span class="token operator">!=</span> del<span class="token punctuation">)</span><span class="token punctuation">)</span> p_Sem <span class="token operator">=</span> p_Sem<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token comment">// if p_Sem not NULL, p_Sem is prev semaphore, else, no prev one</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p_Sem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			p_Sem<span class="token operator">-></span>next <span class="token operator">=</span> del<span class="token operator">-></span>next<span class="token punctuation">;</span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
			del <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> w_Sem <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// no this semaphore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sid<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"w id val=%d\\n"</span><span class="token punctuation">,</span>w_Sem<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	w_Sem<span class="token operator">-></span>val<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>val <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		uint32_t flags<span class="token punctuation">;</span>
		<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// let thread get into wait queue</span>
		<span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_sem_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sem_t<span class="token operator">*</span> w_Sem <span class="token operator">=</span> <span class="token function">AddrSem</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w_Sem<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// no this semaphore</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sid<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"s id val=%d\\n"</span><span class="token punctuation">,</span>w_Sem<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	w_Sem<span class="token operator">-></span>val<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>val <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		uint32_t flags<span class="token punctuation">;</span>
		<span class="token function">save_flags_cli</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>w_Sem<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wake up a thread from wait queue</span>
        <span class="token function">restore_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><blockquote id="https://www.notion.so/c806686f527c4e38bd86978521cc657a" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：AddrSem(sid)可以得到id为sid的信号量x地址，但使用AddrSem(sid-1)来得到链表中信号量x的前一个信号量地址是有缺陷的，因为sid-1的信号量可能已被destroy。但本实验不涉及这个问题，你可以采用AddrSem(sid-1)先得到sid-1的信号量地址Y，然后Y-&gt;next自然便是信号量x的地址。</span></span></blockquote><div id="https://www.notion.so/76579668e4e84f29873e3a1e353aab9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">系统调用的添加，参考前几次实验的添加步骤，大致如下：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/4f2852f53fe34569ac125e08bd16c03d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\include\syscall.h</code></span><span class="SemanticString"> 声明系统调用API</span></span></li><li id="https://www.notion.so/671746028bc94f669237403d0ee89f22" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\userapp\lib\syscall-wrapper.S</code></span><span class="SemanticString"> 定义封装例程</span></span></li><li id="https://www.notion.so/b029ae87cbbd4c33baf3d516882256e4" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\include\syscall-nr.h</code></span><span class="SemanticString"> 定义系统调用号</span></span></li><li id="https://www.notion.so/0c661f67d9474c6bbc6f42a05ae8e076" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\kernel.h</code></span><span class="SemanticString"> 声明系统调用服务例程函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sys_xxx</code></span></span></li><li id="https://www.notion.so/2645bf4349e24389ad06697588d62278" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\sem.c</code></span><span class="SemanticString"> 实现系统调用服务例程函数</span></span></li><li id="https://www.notion.so/dfac390e104b41f7ad9b4ca21184c816" class="NumberedList" value="6"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\kernel\machdep.c</code></span><span class="SemanticString"> 在系统调用分发函数</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">syscall()</code></span><span class="SemanticString">中根据系统调用号加入</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SYSCALL_xxx</code></span><span class="SemanticString">分支。
跳过。</span></span></li></ol><h3 id="https://www.notion.so/4a23709180234b5594c6e402eebffb35" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4a23709180234b5594c6e402eebffb35"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">生产者/消费者设计</span></span></h3><div id="https://www.notion.so/589b2560cfef4c57848cd6b17a22b319" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">后面主要是创建线程，使用线程，画图之类的折腾，略述。
\userapp\main.c中，声明全局变量，信号量ID，buffer大小</span></span></p></div><pre id="https://www.notion.so/7d9f260c79af4f8dbcdc1d5862bb7145" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">ar_Size <span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">bfN <span class="token number">8</span></span></span>
<span class="token keyword">int</span> emp_Sem<span class="token punctuation">,</span> ful_Sem<span class="token punctuation">,</span> mut_Sem<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// empty,full,mutex semaphore</span>
<span class="token keyword">int</span> buf<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// the buffer size, we have {bfN} buffers and each can</span>
						<span class="token comment">// contain {ar_Size} integers</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span><span class="token punctuation">{</span>
	……
	emp_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span>bfN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ful_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	……
<span class="token punctuation">}</span></span></span></span></code></pre><blockquote id="https://www.notion.so/38b2e9bd24664b8f99021c801a8add97" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">注：互斥信号量数量取决于buffer的数量，这样可使生产者在填充新的缓冲区同时，可以让消费者清除旧的缓冲区（针对多消费者多生产者情况）。若只一个，那么只有等生产者线程填充完新的缓冲区，消费者才能清除旧的缓冲区，尽管两者使用的缓冲区并不是同一个。即使生产者线程用完了自己的时间片，由于共用了同一互斥信号量，消费者线程得到时间片也进不了临界区，直到生产者线程完成新缓冲区的填充。</span></span></blockquote><div id="https://www.notion.so/536bdeb95c484af3906cc9ed63a41b79" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面说说生产者与消费者线程函数的创建，模板如下（具体代码见尾部）:
生产者线程函数模板：</span></span></p></div><pre id="https://www.notion.so/3a364d1e9235470fa9895c1161b51a3b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">tsk_foo_producer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 缓冲区编号</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 填充缓冲区代码区</span>
		
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// 切换到下一个缓冲区</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/236677a8b4f843f69c45569bfb6b13f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">消费者线程函数模板：</span></span></p></div><pre id="https://www.notion.so/69d31899b74249efb0aecd1ae7a83912" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">void</span> <span class="token function">tsk_foo_consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 缓冲区编号</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 清空缓冲区代码区</span>
		
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// 切换到下一个缓冲区</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/ea61ad09e50a4ba287f37107692e8619" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ea61ad09e50a4ba287f37107692e8619"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实验结果</span></span></h2><div id="https://www.notion.so/93b4edb7ec3d47aa88a0cf7d9c730344" class="Image Image--PageWidth"><figure><a href="#"><img src="#" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/34b8619ce82049a58bbbef6846df2a89" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以直观地从图中看出，当缓冲区满了，生产者还想生产时，必须等待消费者消费一个缓冲区；缓冲区空时，消费者还想消费，必须等待生产者生产完一个。</span></span></p></div><h2 id="https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/4ec19f3ea3894e28bb44ff11ab9ed277"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">感谢</span></span></h2><div id="https://www.notion.so/bd5fe903e5b54cab88b0093fc3bb4b66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">感谢洪明坚老师的ppt，感谢学长们的实验报告，感谢网上大神的笔记。</span></span></p></div><h2 id="https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/108be8c900ff4f6bb6606cc189b0eb5b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">代码附录</span></span></h2><h3 id="https://www.notion.so/7223cf98e52b469587163be3c67dd7ce" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7223cf98e52b469587163be3c67dd7ce"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">main.c</span></span></h3><pre id="https://www.notion.so/6974a7bfb51e4fa4b4132fdef4a9aa5d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">/*
 * vim: filetype=c:fenc=utf-8:ts=4:et:sw=4:sts=4
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;inttypes.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stddef.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;syscall.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"graphics.h"</span></span>

<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">tlsf_create_with_pool</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> mem<span class="token punctuation">,</span> size_t bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> g_heap<span class="token punctuation">;</span>

<span class="token comment">// lab4</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lab4.h"</span></span>

<span class="token comment">/**
 * GCC insists on __main
 *    &lt;http://gcc.gnu.org/onlinedocs/gccint/Collect2.html>
 */</span>
<span class="token keyword">void</span> <span class="token function">__main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	size_t heap_size <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token operator">*</span> heap_base <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> heap_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>
						   MAP_PRIVATE <span class="token operator">|</span> MAP_ANON<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	g_heap <span class="token operator">=</span> <span class="token function">tlsf_create_with_pool</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">,</span> heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 第一个运行在用户模式的线程所执行的函数
 */</span>


<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"task #%d: I'm the first user task(pv=0x%08x)!\\r\\n"</span><span class="token punctuation">,</span> <span class="token function">task_getid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		   pv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// TODO: Your code goes here</span>
    <span class="token function">test_lab4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">;</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8277968b77b347eba0ad924a5ed3e0d3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">lab4.h</span></span></h3><pre id="https://www.notion.so/050be2a9f9ac408cb5b607b8ebb377e1" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_LAB4_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">_LAB4_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">ar_Size <span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">max_Elem <span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">bfN <span class="token number">8</span></span></span>
<span class="token comment">// global variables</span>
uint16_t scr_X<span class="token punctuation">;</span>		 <span class="token comment">// screen width</span>
uint16_t scr_Y<span class="token punctuation">;</span>		 <span class="token comment">// screen length</span>
uint16_t buf_Xlen<span class="token punctuation">;</span>   <span class="token comment">// each buffer's width</span>
uint16_t line_Ylen<span class="token punctuation">;</span>  <span class="token comment">// each line's height</span>
<span class="token keyword">float</span> line_LenR<span class="token punctuation">;</span>	 <span class="token comment">// the ratio of transforming elements in array to a line's</span>
					 <span class="token comment">// length</span>
<span class="token keyword">int</span> emp_Sem<span class="token punctuation">,</span> ful_Sem<span class="token punctuation">,</span> mut_Sem<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// empty,full,mutex semaphore</span>
<span class="token keyword">int</span> buf<span class="token punctuation">[</span>bfN<span class="token punctuation">]</span><span class="token punctuation">[</span>ar_Size<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// the buffer size, we have {bfN} buffers and each can</span>
						<span class="token comment">// contain {ar_Size} integers</span>

<span class="token comment">// Drwa a line, width = 15</span>
<span class="token keyword">void</span> <span class="token function">DrawLine</span><span class="token punctuation">(</span><span class="token keyword">int</span> x0<span class="token punctuation">,</span> <span class="token keyword">int</span> y0<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> COLORREF cr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> j<span class="token punctuation">,</span> y0 <span class="token operator">+</span> i<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Draw the bar to show priority</span>
<span class="token keyword">void</span> <span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> LorR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN<span class="token punctuation">;</span>
	COLORREF cr<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>LorR <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		seqN <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		seqN <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
		cr <span class="token operator">=</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> x0 <span class="token operator">=</span> seqN <span class="token operator">*</span> buf_Xlen <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">39</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
			<span class="token function">setPixel</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// set time delay for thread action</span>
<span class="token keyword">void</span> <span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token keyword">long</span> lMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">long</span> lRemainingMilliSecond <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> lNanoSecond <span class="token operator">=</span> lRemainingMilliSecond <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timespec</span> ts_sleep<span class="token punctuation">,</span> ts_remaining<span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>lMs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	ts_sleep<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> lNanoSecond<span class="token punctuation">;</span>
	<span class="token function">nanosleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_sleep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts_remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// swap lines between a_lineNum and b_lineNum in the seqNum buffer</span>
<span class="token keyword">void</span> <span class="token function">SwapBufLine</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> seqNum<span class="token punctuation">,</span> <span class="token keyword">int</span> a_lineNum<span class="token punctuation">,</span> <span class="token keyword">int</span> b_lineNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> a_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
			 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> b_lineNum <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span>
			 buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
			 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tmp <span class="token operator">=</span> array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>a_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	array<span class="token punctuation">[</span>b_lineNum<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Bubble Sort</span>
<span class="token keyword">void</span> <span class="token function">BubbleSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> seqNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token comment">// Draw again, unnecessary,just for beauty</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqNum <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
				 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqNum<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// start to sort this buffer</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> ar_Size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">SwapBufLine</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> seqNum<span class="token punctuation">,</span> j<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// controller can change the priority</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_control</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> key<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> tid_List <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>pv<span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_A <span class="token operator">=</span> tid_List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_B <span class="token operator">=</span> tid_List<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Draw priority bar first</span>
		<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DrawPrioBar</span><span class="token punctuation">(</span><span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		key <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wait for input</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x4800</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// UP</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x5000</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// DOWN</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_A<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4d00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// RIGHT</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0x4b00</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// LEFT</span>
				<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">,</span> <span class="token function">getpriority</span><span class="token punctuation">(</span>tid_B<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// producer: generate rand arrays and put into buffer</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_producer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// the sequence number of buffer</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// output the buffer</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> max_Elem<span class="token punctuation">;</span>
			<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqN <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> line_LenR<span class="token punctuation">,</span>
					 <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// next buffer</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// consumer: sort the array in buffer outside critical region</span>
<span class="token keyword">void</span> <span class="token function">tsk_foo_consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> seqN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// the sequence number of buffer</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BubbleSort</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">,</span> seqN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// clear the buffer</span>
		<span class="token function">DrawDelay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> i<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ar_Size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token function">DrawLine</span><span class="token punctuation">(</span>seqN <span class="token operator">*</span> buf_Xlen<span class="token punctuation">,</span> i <span class="token operator">*</span> line_Ylen<span class="token punctuation">,</span> buf_Xlen<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>seqN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sem_signal</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		seqN <span class="token operator">=</span> <span class="token punctuation">(</span>seqN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bfN<span class="token punctuation">;</span>  <span class="token comment">// next buffer</span>
	<span class="token punctuation">}</span>
	<span class="token function">task_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// test function</span>
<span class="token keyword">void</span> <span class="token function">test_lab4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// enter the gui</span>
	<span class="token keyword">int</span> graphMode <span class="token operator">=</span> <span class="token number">0x143</span><span class="token punctuation">;</span>
	<span class="token function">init_graphic</span><span class="token punctuation">(</span>graphMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initialize the semaphore</span>
	emp_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span>bfN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ful_Sem <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initial the parameter used to draw</span>
	scr_X <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>XResolution<span class="token punctuation">;</span>
	scr_Y <span class="token operator">=</span> g_graphic_dev<span class="token punctuation">.</span>YResolution<span class="token punctuation">;</span>
	buf_Xlen <span class="token operator">=</span> scr_X <span class="token operator">/</span> <span class="token punctuation">(</span>bfN <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	line_Ylen <span class="token operator">=</span> scr_Y <span class="token operator">/</span> <span class="token punctuation">(</span>ar_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	line_LenR <span class="token operator">=</span> <span class="token punctuation">(</span>buf_Xlen <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>max_Elem<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// alloc stack space</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> st_Size <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>stk_Pro<span class="token punctuation">,</span> <span class="token operator">*</span>stk_Con<span class="token punctuation">,</span> <span class="token operator">*</span>stk_Ctr<span class="token punctuation">;</span>
	stk_Pro <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	stk_Con <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	stk_Ctr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>st_Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// create threads</span>
	<span class="token keyword">int</span> tid_Pro<span class="token punctuation">,</span> tid_Con<span class="token punctuation">,</span> tid_Ctr<span class="token punctuation">;</span>
	tid_Pro <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Pro <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_producer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tid_Con <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Con <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_consumer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> tid_List<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>tid_Pro<span class="token punctuation">,</span> tid_Con<span class="token punctuation">}</span><span class="token punctuation">;</span>
	tid_Ctr <span class="token operator">=</span> <span class="token function">task_create</span><span class="token punctuation">(</span>stk_Ctr <span class="token operator">+</span> st_Size<span class="token punctuation">,</span> tsk_foo_control<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tid_List<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// initial the priorities</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Pro<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Con<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setpriority</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nice = -19</span>

	<span class="token comment">// exit all threads</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Pro<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Con<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_wait</span><span class="token punctuation">(</span>tid_Ctr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Pro<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Con<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>stk_Ctr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// free the semaphore</span>
	<span class="token function">sem_destroy</span><span class="token punctuation">(</span>emp_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_destroy</span><span class="token punctuation">(</span>ful_Sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bfN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">sem_destroy</span><span class="token punctuation">(</span>mut_Sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">//_LAB4_</span></span></span></span></span></code></pre></article>  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: 'x3yNlOp8snKVbHLuM3MDgyPm-gzGzoHsz',
      appKey: 'IxbPmtJ4C181kqwCPyUfHb67',
      avatar: 'retro',
      placeholder: 'Welcome to comment here233!',
      requiredFields: ['nick', 'mail']
    })
  </script>
  <footer class="Footer">
    <div>&copy; idzc.me 2020</div>
    <div>&centerdot;</div>
    <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
        rel="noopener noreferrer">Notablog</a>.
    </div>
  </footer>
</body>

</html>